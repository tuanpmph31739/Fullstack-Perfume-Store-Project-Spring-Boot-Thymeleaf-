<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/admin/fragments/head :: head}"></head>
<body>
<div class="wrapper">
    <aside th:replace="/admin/fragments/sidebar :: sidebar"></aside>
    <div id="main">
        <header th:replace="~{/admin/fragments/header :: header(${nguoiDung.id == null ? 'Thêm nhân viên' : 'Sửa nhân viên'})}"></header>

        <div class="page-content">
            <div class="card p-4">
                <form id="formNguoiDung" th:action="@{/admin/nhan-vien/save}" th:object="${nguoiDung}" method="post">
                    <input type="hidden" th:field="*{id}" id="userId">
                    <input type="hidden" id="oldEmail" th:value="${nguoiDung.email}">

                    <input type="hidden" th:field="*{vaiTro}">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Mã nhân viên</label>
                            <input type="text" class="form-control" th:field="*{ma}" placeholder="Tự động tạo">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Họ tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" th:field="*{hoTen}" id="hoTen">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" th:field="*{email}" id="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Mật khẩu</label>
                            <input type="password" class="form-control" name="newPassword" id="matKhau"
                                   placeholder="Để trống nếu không đổi">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Giới tính</label>
                            <select class="form-select" th:field="*{gioiTinh}">
                                <option value="1">Nam</option>
                                <option value="0">Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ngày sinh</label>
                            <input type="date" class="form-control" th:field="*{ngaySinh}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">SĐT</label>
                            <input type="text" class="form-control" th:field="*{sdt}" id="sdt">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Địa chỉ</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <select class="form-select" id="nv-province">
                                        <option value="">Tỉnh / Thành phố</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="nv-district">
                                        <option value="">Quận / Huyện</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="nv-ward">
                                        <option value="">Phường / Xã</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <input type="text"
                                           class="form-control mt-2"
                                           id="nv-street"
                                           placeholder="Số nhà, tên đường...">
                                </div>
                            </div>

                            <!-- Hidden bind về NguoiDung.diaChi -->
                            <input type="hidden" th:field="*{diaChi}" id="nv-fullAddress">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Trạng thái</label>
                            <select class="form-select" th:field="*{trangThai}">
                                <option value="true">Hoạt động</option>
                                <option value="false">Khóa</option>
                            </select>
                        </div>
                    </div>


                    <div class="text-end mt-3">
                        <a href="/admin/nhan-vien" class="btn btn-secondary">Quay lại</a>
                        <button type="submit" class="btn btn-success">Lưu lại</button>
                    </div>
                </form>
            </div>
        </div>
        <footer th:replace="/admin/fragments/footer :: footer"></footer>
    </div>
</div>
<script th:replace="/admin/fragments/script :: script"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {

        // ========== ĐỊa CHỈ NHÂN VIÊN (nv-*) ==========
        const nvProvince = document.getElementById("nv-province");
        const nvDistrict = document.getElementById("nv-district");
        const nvWard     = document.getElementById("nv-ward");
        const nvStreet   = document.getElementById("nv-street");
        const nvFullAddr = document.getElementById("nv-fullAddress");

        function splitAddress(addr) {
            const parts = addr.split(',')
                .map(p => p.trim())
                .filter(p => p.length > 0);

            let province = "", district = "", ward = "", street = "";

            if (parts.length >= 4) {
                province = parts[parts.length - 1];
                district = parts[parts.length - 2];
                ward     = parts[parts.length - 3];
                street   = parts.slice(0, parts.length - 3).join(", ");
            } else if (parts.length === 3) {
                province = parts[2];
                district = parts[1];
                street   = parts[0];
            } else if (parts.length === 2) {
                province = parts[1];
                street   = parts[0];
            } else if (parts.length === 1) {
                street   = parts[0];
            }
            return { province, district, ward, street };
        }

        function findOptionByName(select, targetName) {
            if (!select || !targetName) return null;
            const normTarget = targetName.toLowerCase();
            let found = null;
            Array.from(select.options).forEach(opt => {
                const name = (opt.textContent || "").toLowerCase();
                if (!name) return;
                if (name === normTarget || name.includes(normTarget) || normTarget.includes(name)) {
                    found = opt;
                }
            });
            return found;
        }

        function updateNvFullAddress() {
            if (!nvProvince || !nvDistrict || !nvWard || !nvStreet || !nvFullAddr) return;

            const p = nvProvince.value ? nvProvince.options[nvProvince.selectedIndex].text.trim() : "";
            const d = nvDistrict.value ? nvDistrict.options[nvDistrict.selectedIndex].text.trim() : "";
            const w = nvWard.value     ? nvWard.options[nvWard.selectedIndex].text.trim()        : "";
            const s = nvStreet.value.trim();

            const arr = [];
            if (s) arr.push(s);
            if (w) arr.push(w);
            if (d) arr.push(d);
            if (p) arr.push(p);

            nvFullAddr.value = arr.join(", ");
        }

        if (nvProvince && nvDistrict && nvWard && nvStreet && nvFullAddr) {
            nvDistrict.disabled = true;
            nvWard.disabled     = true;

            const existingNvAddress = (nvFullAddr.value || "").trim();

            function autoFillNvAddress() {
                if (!existingNvAddress) return;

                const parts = splitAddress(existingNvAddress);
                if (!parts.province) return;

                if (parts.street) {
                    nvStreet.value = parts.street;
                }

                const provOpt = findOptionByName(nvProvince, parts.province);
                if (!provOpt) { updateNvFullAddress(); return; }

                nvProvince.value   = provOpt.value;
                nvDistrict.disabled = false;

                fetch(`https://esgoo.net/api-tinhthanh/2/${provOpt.value}.htm`)
                    .then(r => r.json())
                    .then(data => {
                        nvDistrict.innerHTML = '<option value="">Quận / Huyện</option>';
                        if (data.error === 0) {
                            data.data.forEach(item => {
                                const opt = new Option(item.full_name, item.id);
                                nvDistrict.add(opt);
                            });
                        }

                        if (!parts.district) { updateNvFullAddress(); return; }

                        const distOpt = findOptionByName(nvDistrict, parts.district);
                        if (!distOpt) { updateNvFullAddress(); return; }

                        nvDistrict.value = distOpt.value;
                        nvWard.disabled  = false;

                        return fetch(`https://esgoo.net/api-tinhthanh/3/${distOpt.value}.htm`)
                            .then(r => r.json())
                            .then(data2 => {
                                nvWard.innerHTML = '<option value="">Phường / Xã</option>';
                                if (data2.error === 0) {
                                    data2.data.forEach(item => {
                                        const opt = new Option(item.full_name, item.id);
                                        nvWard.add(opt);
                                    });
                                }

                                if (parts.ward) {
                                    const wardOpt = findOptionByName(nvWard, parts.ward);
                                    if (wardOpt) nvWard.value = wardOpt.value;
                                }

                                updateNvFullAddress();
                            });
                    })
                    .catch(err => console.error("Lỗi auto-fill địa chỉ NV:", err));
            }

            fetch('https://esgoo.net/api-tinhthanh/1/0.htm')
                .then(r => r.json())
                .then(data => {
                    if (data.error === 0) {
                        data.data.forEach(item => {
                            const opt = new Option(item.full_name, item.id);
                            nvProvince.add(opt);
                        });
                    }
                    autoFillNvAddress();
                })
                .catch(err => console.error("Lỗi load tỉnh NV:", err));

            nvProvince.addEventListener("change", function () {
                nvDistrict.innerHTML = '<option value="">Quận / Huyện</option>';
                nvWard.innerHTML     = '<option value="">Phường / Xã</option>';
                nvWard.disabled      = true;

                if (this.value) {
                    nvDistrict.disabled = false;
                    fetch(`https://esgoo.net/api-tinhthanh/2/${this.value}.htm`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.error === 0) {
                                data.data.forEach(item => {
                                    const opt = new Option(item.full_name, item.id);
                                    nvDistrict.add(opt);
                                });
                            }
                        })
                        .catch(err => console.error("Lỗi load huyện NV:", err));
                } else {
                    nvDistrict.disabled = true;
                }
                updateNvFullAddress();
            });

            nvDistrict.addEventListener("change", function () {
                nvWard.innerHTML = '<option value="">Phường / Xã</option>';
                if (this.value) {
                    nvWard.disabled = false;
                    fetch(`https://esgoo.net/api-tinhthanh/3/${this.value}.htm`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.error === 0) {
                                data.data.forEach(item => {
                                    const opt = new Option(item.full_name, item.id);
                                    nvWard.add(opt);
                                });
                            }
                        })
                        .catch(err => console.error("Lỗi load xã NV:", err));
                } else {
                    nvWard.disabled = true;
                }
                updateNvFullAddress();
            });

            nvWard.addEventListener("change", updateNvFullAddress);
            nvStreet.addEventListener("input", updateNvFullAddress);
        }

        // ========== SWEETALERT + CHECK EMAIL NHÂN VIÊN ==========
        const form = document.getElementById("formNguoiDung");
        const successMsg = [[${success}]];
        const errorMsg   = [[${error}]];

        if (successMsg) {
            Swal.fire({
                icon: 'success',
                title: 'Thành công!',
                text: successMsg,
                timer: 2000,
                showConfirmButton: false
            });
        }
        if (errorMsg) {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: errorMsg
            });
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const id       = document.getElementById("userId").value;
            const email    = document.getElementById("email").value.trim();
            const oldEmail = document.getElementById("oldEmail").value.trim();
            const hoTen    = document.getElementById("hoTen").value.trim();
            const matKhau  = document.getElementById("matKhau").value.trim();

            if (!hoTen)  return Swal.fire("Lỗi", "Nhập họ tên", "error");
            if (!email)  return Swal.fire("Lỗi", "Nhập email", "error");
            if (!id && !matKhau) return Swal.fire("Lỗi", "Nhập mật khẩu cho nhân viên mới", "error");

            if (!id || (id && email !== oldEmail)) {
                const res    = await fetch(`/admin/nhan-vien/check-email?email=${encodeURIComponent(email)}`);
                const exists = await res.json();
                if (exists) {
                    return Swal.fire("Lỗi", "Email đã tồn tại", "error");
                }
            }

            Swal.fire({
                title: "Lưu nhân viên?",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Lưu"
            }).then(r => {
                if (r.isConfirmed) {
                    // Cập nhật hidden địa chỉ trước khi submit
                    updateNvFullAddress();
                    form.submit();
                }
            });
        });
    });
</script>

</body>
</html>