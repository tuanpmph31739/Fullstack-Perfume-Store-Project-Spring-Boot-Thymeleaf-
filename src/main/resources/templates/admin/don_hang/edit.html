<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/admin/fragments/head :: head}"></head>
<body>
<div class="wrapper">

    <!-- SIDEBAR -->
    <aside th:replace="~{/admin/fragments/sidebar :: sidebar}"></aside>

    <div id="main">
        <!-- HEADER -->
        <header th:replace="~{/admin/fragments/header :: header('Quản lý Đơn hàng')}"></header>

        <!-- PAGE TITLE -->
        <div class="page-heading">
            <div class="page-title">
                <div class="row align-items-center">
                    <div class="col-12 col-md-7 order-md-1 order-last">
                        <h3 class="mb-1">
                            Sửa đơn hàng
                            <span class="text-muted ms-2" th:text="${donHang.ma}">HD-XXXX</span>
                        </h3>
                        <p class="text-muted mb-0 small">
                            Tạo lúc
                            <span th:text="${#temporals.format(donHang.ngayTao, 'dd/MM/yyyy HH:mm')}">
                                01/01/2025 10:00
                            </span>
                            • Kênh bán:
                            <span class="fw-semibold"
                                  th:text="${donHang.kenhBan == 'TAI_QUAY' ? 'Đơn hàng tại quầy' : 'Đơn hàng online'}">
                                Đơn hàng online
                            </span>
                        </p>
                    </div>
                    <div class="col-12 col-md-5 order-md-2 order-first text-md-end mt-2 mt-md-0">
                        <a th:href="${backUrl}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left"></i> Quay lại
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE CONTENT -->
        <div class="page-content">

            <div class="page-content">

                <!-- THÔNG BÁO FLASH -->
                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-1"></i>
                    <span th:text="${successMessage}">Lưu đơn hàng thành công!</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>
                    <span th:text="${errorMessage}">Có lỗi xảy ra</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

            </div>

            <!-- STYLE RIÊNG -->
            <style>
                .order-meta-label {
                    font-size: 12px;
                    color: #6b7280;
                    text-transform: uppercase;
                    letter-spacing: .03em;
                    font-weight: 600;
                }
                .order-meta-value {
                    font-size: 14px;
                    font-weight: 500;
                    color: #111827;
                }
                .order-summary-card {
                    border-radius: 16px;
                    border: none;
                    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
                }
                .order-total-row {
                    font-size: 14px;
                }
                .order-total-row span:first-child {
                    color: #4b5563;
                }
                .order-total-highlight {
                    font-size: 20px;
                    font-weight: 700;
                    color: #dc2626;
                }

                .status-chip {
                    border-radius: 999px;
                    border: 1px solid #e5e7eb;
                    background: #f9fafb;
                    padding: 6px 12px;
                    font-size: 13px;
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    cursor: default;
                    transition: all 0.15s ease-in-out;
                }
                .status-chip i {
                    font-size: 16px;
                }
                .status-chip--current {
                    border-color: #2563eb;
                    background: #eff6ff;
                    color: #1d4ed8;
                    font-weight: 600;
                }
                .status-chip[data-clickable='true'] {
                    cursor: pointer;
                }
                .status-chip[data-clickable='true']:hover {
                    border-color: #2563eb;
                    background: #e0ecff;
                }
                .status-chip--selected {
                    border-color: #16a34a !important;
                    background: #dcfce7 !important;
                    color: #166534 !important;
                    font-weight: 600;
                }
                .status-chip[data-clickable='false'] {
                    opacity: 0.5;
                    cursor: not-allowed;
                }
            </style>

            <section class="row">
                <div class="col-12">

                    <form th:action="@{'/admin/don-hang/edit/' + ${donHang.id}}"
                          method="post"
                          class="row g-3">

                        <!-- CỘT TRÁI: THÔNG TIN + SẢN PHẨM -->
                        <div class="col-xl-8">

                            <!-- CARD: THÔNG TIN ĐƠN -->
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-receipt-cutoff me-2 text-primary"></i>
                                            Chỉnh sửa thông tin đơn hàng
                                        </h5>
                                        <small class="text-muted">Cập nhật thông tin người nhận và trạng thái xử lý</small>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">

                                        <!-- Thông tin hệ thống -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <div class="order-meta-label">Mã đơn hàng</div>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       th:value="${donHang.ma}"
                                                       readonly>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Kênh bán</div>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       th:value="${donHang.kenhBan == 'TAI_QUAY' ? 'Đơn hàng tại quầy' : 'Đơn hàng online'}"
                                                       readonly>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Phương thức thanh toán</div>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       th:value="${donHang.phuongThucThanhToan ?: '---'}"
                                                       readonly>
                                            </div>
                                        </div>

                                        <!-- Khách & ngày -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <div class="order-meta-label">Khách hàng (tài khoản)</div>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       th:value="${donHang.tenKhachHang != null ? donHang.tenKhachHang : 'Khách hàng không đăng nhập'}"
                                                       readonly>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Ngày tạo</div>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       th:value="${#temporals.format(donHang.ngayTao, 'dd/MM/yyyy HH:mm')}"
                                                       readonly>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Ngày thanh toán</div>
                                                <input type="text"
                                                       class="form-control form-control-sm"
                                                       th:value="${donHang.ngayThanhToan != null ? #temporals.format(donHang.ngayThanhToan, 'dd/MM/yyyy HH:mm') : ''}"
                                                       readonly>
                                            </div>
                                        </div>

                                        <!-- Người nhận -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <div class="order-meta-label">Tên người nhận</div>
                                                <input type="text"
                                                       name="tenNguoiNhan"
                                                       class="form-control form-control-sm"
                                                       th:value="${donHang.tenNguoiNhan}"
                                                       th:readonly="${donHang.trangThai == 'HOAN_THANH' or donHang.trangThai == 'DA_HUY'}">
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Số điện thoại</div>
                                                <input type="text"
                                                       name="sdt"
                                                       class="form-control form-control-sm"
                                                       th:value="${donHang.sdt}"
                                                       th:readonly="${donHang.trangThai == 'HOAN_THANH' or donHang.trangThai == 'DA_HUY'}">
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Email</div>
                                                <input type="text"
                                                       name="email"
                                                       class="form-control form-control-sm"
                                                       th:value="${donHang.email}"
                                                       readonly>
                                            </div>
                                        </div>

                                        <!-- Địa chỉ -->
                                        <div class="col-12">
                                            <div class="order-meta-label mb-1">Địa chỉ giao hàng</div>
                                            <textarea name="diaChi"
                                                      rows="2"
                                                      class="form-control form-control-sm"
                                                      th:text="${donHang.diaChi}"
                                                      th:readonly="${donHang.trangThai == 'HOAN_THANH' or donHang.trangThai == 'DA_HUY'}"></textarea>
                                        </div>

                                        <div class="col-12 mt-1"
                                             th:if="${donHang.trangThai == 'HOAN_THANH' or donHang.trangThai == 'DA_HUY'}">
                                            <small class="text-muted">
                                                <i class="bi bi-lock-fill"></i>
                                                Đơn đã hoàn thành hoặc đã hủy, không thể chỉnh sửa thông tin người nhận.
                                            </small>
                                        </div>
                                        <!-- input ẩn + status chips -->
                                        <input type="hidden"
                                               id="trangThaiInput"
                                               name="trangThai"
                                               th:value="${donHang.trangThai}"/>

                                        <!-- LƯU TRẠNG THÁI GỐC ĐỂ SO SÁNH -->
                                        <input type="hidden"
                                               id="originalTrangThai"
                                               th:value="${donHang.trangThai}"/>

                                        <div class="col-12 mt-2">
                                            <label class="order-meta-label d-block mb-2">Trạng thái đơn hàng</label>

                                            <div class="d-flex flex-wrap align-items-center gap-2" id="statusChips">
                                                <!-- DANG_CHO_THANH_TOAN -->
                                                <button type="button"
                                                        class="status-chip"
                                                        data-status="DANG_CHO_THANH_TOAN"
                                                        data-label="ĐANG CHỜ THANH TOÁN"
                                                        th:classappend="${donHang.trangThai == 'DANG_CHO_THANH_TOAN'} ? ' status-chip--current' : ''"
                                                        th:data-clickable="${#lists.contains(allowedTrangThais, 'DANG_CHO_THANH_TOAN')}">
                                                    <i class="bi bi-credit-card"></i>
                                                    <span>Đang chờ thanh toán</span>
                                                </button>

                                                <!-- CHO_XAC_NHAN -->
                                                <button type="button"
                                                        class="status-chip"
                                                        data-status="CHO_XAC_NHAN"
                                                        data-label="CHỜ XÁC NHẬN"
                                                        th:classappend="${donHang.trangThai == 'CHO_XAC_NHAN'} ? ' status-chip--current' : ''"
                                                        th:data-clickable="${#lists.contains(allowedTrangThais, 'CHO_XAC_NHAN')}">
                                                    <i class="bi bi-hourglass-split"></i>
                                                    <span>Chờ xác nhận</span>
                                                </button>

                                                <!-- DANG_CHUAN_BI -->
                                                <button type="button"
                                                        class="status-chip"
                                                        data-status="DANG_CHUAN_BI"
                                                        data-label="ĐANG CHUẨN BỊ"
                                                        th:classappend="${donHang.trangThai == 'DANG_CHUAN_BI'} ? ' status-chip--current' : ''"
                                                        th:data-clickable="${#lists.contains(allowedTrangThais, 'DANG_CHUAN_BI')}">
                                                    <i class="bi bi-box-seam"></i>
                                                    <span>Đang chuẩn bị</span>
                                                </button>

                                                <!-- DANG_GIAO -->
                                                <button type="button"
                                                        class="status-chip"
                                                        data-status="DANG_GIAO"
                                                        data-label="ĐANG GIAO"
                                                        th:classappend="${donHang.trangThai == 'DANG_GIAO'} ? ' status-chip--current' : ''"
                                                        th:data-clickable="${#lists.contains(allowedTrangThais, 'DANG_GIAO')}">
                                                    <i class="bi bi-truck"></i>
                                                    <span>Đang giao</span>
                                                </button>

                                                <!-- HOAN_THANH -->
                                                <button type="button"
                                                        class="status-chip"
                                                        data-status="HOAN_THANH"
                                                        data-label="HOÀN THÀNH"
                                                        th:classappend="${donHang.trangThai == 'HOAN_THANH'} ? ' status-chip--current' : ''"
                                                        th:data-clickable="${#lists.contains(allowedTrangThais, 'HOAN_THANH')}">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                    <span>Hoàn thành</span>
                                                </button>

                                                <!-- DA_HUY -->
                                                <button type="button"
                                                        class="status-chip"
                                                        data-status="DA_HUY"
                                                        data-label="ĐÃ HỦY"
                                                        th:classappend="${donHang.trangThai == 'DA_HUY'} ? ' status-chip--current' : ''"
                                                        th:data-clickable="${#lists.contains(allowedTrangThais, 'DA_HUY')}">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                    <span>Đã hủy</span>
                                                </button>
                                            </div>

                                            <!-- Dòng hiển thị: [trạng thái DB] -> [trạng thái mới] -->
                                            <small class="text-muted d-block mt-2 fw-semibold">
                                                Trạng thái:
                                                <!-- label trạng thái hiện tại trong DB (LUÔN cố định) -->
                                                <span id="currentStatusLabel" class="fw-semibold"
                                                      th:text="${donHang.trangThai == 'DANG_CHO_THANH_TOAN' ? 'ĐANG CHỜ THANH TOÁN' :
                       donHang.trangThai == 'CHO_XAC_NHAN'        ? 'CHỜ XÁC NHẬN' :
                       donHang.trangThai == 'DANG_CHUAN_BI'        ? 'ĐANG CHUẨN BỊ' :
                       donHang.trangThai == 'DANG_GIAO'            ? 'ĐANG GIAO' :
                       donHang.trangThai == 'HOAN_THANH'           ? 'HOÀN THÀNH' :
                       donHang.trangThai == 'DA_HUY'               ? 'ĐÃ HỦY' :
                                                                      donHang.trangThai}">
        </span>

                                                <!-- mũi tên + trạng thái sắp tới (ẩn nếu chưa chọn khác) -->
                                                <span id="arrowStatus" class="fw-semibold text-primary d-none"> → </span>
                                                <span id="nextStatusLabel" class="fw-semibold text-primary d-none"></span>
                                            </small>
                                        </div>


                                        <div class="col-12 mt-1 d-flex justify-content-end gap-2">
                                            <a th:href="${backUrl}" class="btn btn-outline-secondary btn-sm">
                                                Hủy
                                            </a>
                                            <button type="submit"
                                                    class="btn btn-primary btn-sm"
                                                    onclick="return confirm('Xác nhận lưu thay đổi đơn hàng?');">
                                                Lưu thay đổi
                                            </button>
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- CARD: SẢN PHẨM TRONG ĐƠN (READ-ONLY) -->
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-bag-check me-2 text-primary"></i>
                                            Sản phẩm trong đơn
                                        </h5>
                                        <small class="text-muted">Danh sách sản phẩm khách đã đặt (chỉ xem, sửa ở màn khác nếu cần)</small>
                                    </div>
                                </div>
                                <div class="card-body table-responsive">
                                    <table class="table table-sm table-striped table-hover align-middle mb-0">
                                        <thead class="table-light">
                                        <tr class="text-nowrap">
                                            <th>STT</th>
                                            <th>Ảnh</th>
                                            <th>Sản phẩm</th>
                                            <th>Thương hiệu</th>
                                            <th>Nồng độ</th>
                                            <th>SKU</th>
                                            <th class="text-center">Số lượng</th>
                                            <th class="text-end">Đơn giá</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="ct, iter : ${chiTietList}">
                                            <td th:text="${iter.index + 1}">1</td>
                                            <td>
                                                <img th:if="${ct.getSanPhamChiTiet().getHinhAnh()}"
                                                     th:src="@{'/images/uploads/' + ${ct.getSanPhamChiTiet().getHinhAnh()}}"
                                                     class="rounded border"
                                                     style="max-width:50px; max-height:50px; object-fit:cover;">
                                                <span th:unless="${ct.getSanPhamChiTiet().getHinhAnh()}">---</span>
                                            </td>
                                            <td>
                                                <div class="fw-semibold"
                                                     th:text="${ct.sanPhamChiTiet.sanPham.tenNuocHoa}">
                                                    Tên nước hoa
                                                </div>
                                                <div class="text-muted small">
                                                    <span th:text="${ct.sanPhamChiTiet.getDungTich().soMl}">50</span> ml
                                                </div>
                                            </td>
                                            <td th:text="${ct.getSanPhamChiTiet().sanPham.getThuongHieu().tenThuongHieu}">Thương hiệu</td>
                                            <td th:text="${ct.sanPhamChiTiet.getNongDo().getTenNongDo()}">EDT</td>
                                            <td th:text="${ct.sanPhamChiTiet.maSKU}">SKU</td>
                                            <td class="text-center" th:text="${ct.soLuong}">1</td>
                                            <td class="text-end" style="font-weight:bold; color:#dc2626;"
                                                th:text="${#numbers.formatDecimal(ct.donGia, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                1.000.000 ₫
                                            </td>
                                        </tr>

                                        <tr th:if="${chiTietList == null or #lists.isEmpty(chiTietList)}">
                                            <td colspan="8" class="text-center text-muted py-3">
                                                Không có dữ liệu chi tiết đơn hàng.
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                        <!-- CỘT PHẢI: TỔNG TIỀN -->
                        <div class="col-xl-4">
                            <div class="card order-summary-card mb-3">
                                <div class="card-header border-0 pb-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">
                                                <i class="bi bi-currency-exchange me-2 text-success"></i>
                                                Tổng quan thanh toán
                                            </h5>
                                            <small class="text-muted">
                                                Thông tin chỉ đọc, tự động tính từ hệ thống.
                                            </small>
                                        </div>
                                        <div class="badge bg-light text-dark">
                                            <i class="bi bi-hash"></i>
                                            <span th:text="${donHang.id}">0</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">

                                    <div class="mb-3">
                                        <div class="order-total-row d-flex justify-content-between mb-1">
                                            <span>Tiền hàng</span>
                                            <span class="fw-semibold"
                                                  th:text="${#numbers.formatDecimal(donHang.tongTienHang, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫
                                            </span>
                                        </div>
                                        <div class="order-total-row d-flex justify-content-between mb-1">
                                            <span>Giảm giá</span>
                                            <span class="fw-semibold text-danger"
                                                  th:text="${#numbers.formatDecimal(donHang.tienGiamGia, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫
                                            </span>
                                        </div>
                                        <div class="order-total-row d-flex justify-content-between mb-1">
                                            <span>Phí ship</span>
                                            <span class="fw-semibold"
                                                  th:text="${#numbers.formatDecimal(donHang.phiShip, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫
                                            </span>
                                        </div>
                                        <hr class="my-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-semibold">TỔNG THANH TOÁN</span>
                                            <span class="order-total-highlight"
                                                  th:text="${#numbers.formatDecimal(donHang.tongThanhToan, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫
                                            </span>
                                        </div>
                                    </div>

                                    <div class="mt-3 small text-muted">
                                        <div class="mb-1">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Mọi thay đổi liên quan đến tiền hàng / giảm giá nên thao tác ở màn hình xử lý nghiệp vụ tương ứng.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>

                </div>
            </section>
        </div>

        <!-- FOOTER -->
        <footer th:replace="~{/admin/fragments/footer :: footer}"></footer>
    </div>
</div>

<div th:replace="~{/admin/fragments/script :: script}"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chips        = document.querySelectorAll('#statusChips .status-chip');
        const hiddenInput  = document.getElementById('trangThaiInput');
        const originalInput = document.getElementById('originalTrangThai');

        const currentLabelSpan = document.getElementById('currentStatusLabel');
        const arrowSpan        = document.getElementById('arrowStatus');
        const nextLabelSpan    = document.getElementById('nextStatusLabel');

        const originalStatus = originalInput ? originalInput.value : null;

        chips.forEach(chip => {
            const clickable = chip.getAttribute('data-clickable') === 'true';
            if (!clickable) return;

            chip.addEventListener('click', function () {
                // Bỏ chọn chip cũ, chọn chip mới
                chips.forEach(c => c.classList.remove('status-chip--selected'));
                this.classList.add('status-chip--selected');

                const newStatus = this.getAttribute('data-status');
                const newLabel  = this.getAttribute('data-label') || newStatus;

                // cập nhật giá trị submit
                hiddenInput.value = newStatus;

                // Nếu chọn lại đúng trạng thái gốc -> ẩn mũi tên + trạng thái mới
                if (originalStatus && newStatus === originalStatus) {
                    arrowSpan.classList.add('d-none');
                    nextLabelSpan.classList.add('d-none');
                    nextLabelSpan.textContent = '';
                } else {
                    // Hiện mũi tên + trạng thái sắp tới
                    arrowSpan.classList.remove('d-none');
                    nextLabelSpan.classList.remove('d-none');
                    nextLabelSpan.textContent = newLabel;
                }
            });
        });
    });
</script>


</body>
</html>
