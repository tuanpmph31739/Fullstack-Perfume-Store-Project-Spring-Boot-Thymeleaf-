<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/admin/fragments/head :: head}"></head>
<body>
<div class="wrapper">

    <!-- SIDEBAR -->
    <aside th:replace="~{/admin/fragments/sidebar :: sidebar}"></aside>

    <div id="main">
        <!-- HEADER -->
        <header th:replace="~{/admin/fragments/header :: header}"></header>

        <!-- PAGE TITLE -->
        <div class="page-heading">
            <div class="page-title">
                <div class="row align-items-center">
                    <div class="col-12 col-md-7 order-md-1 order-last">
                        <h3 class="mb-1">
                            Chi tiết hóa đơn
                            <span class="text-muted ms-2" th:text="${hoaDon.ma} ?: 'HD-XXXX'">HD-XXXX</span>
                        </h3>
                        <p class="text-muted mb-0 small">
                            Tạo lúc
                            <span th:text="${hoaDon.ngayTao != null ? #temporals.format(hoaDon.ngayTao, 'dd/MM/yyyy HH:mm') : '-'}">
                                01/01/2025 10:00
                            </span>
                            • Kênh bán:
                            <span class="fw-semibold"
                                  th:text="${
                                        hoaDon.kenhBan == 'TAI_QUAY' ? 'Đơn hàng tại quầy'
                                      : (hoaDon.kenhBan == 'WEB' ? 'Đơn hàng online' : '-')
                                  }">
                                Đơn hàng online
                            </span>
                        </p>
                    </div>
                    <div class="col-12 col-md-5 order-md-2 order-first text-md-end mt-2 mt-md-0">
                        <!-- In hóa đơn -->
                        <a th:href="@{/admin/hoa-don/print/{id}(id=${hoaDon.id})}"
                           class="btn btn-outline-success"
                           target="_blank"
                           title="In hóa đơn">
                            <i class="bi bi-printer"></i>
                        </a>

                        <!-- Quay lại -->
                        <a th:href="${backUrl}" class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-arrow-left"></i> Quay lại danh sách
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-content">

            <!-- STYLE RIÊNG CHO TRANG HÓA ĐƠN -->
            <style>
                .order-summary-card {
                    border-radius: 16px;
                    border: none;
                    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
                }
                .order-header-chip {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 4px 10px;
                    border-radius: 999px;
                    background: #f3f4f6;
                    font-size: 12px;
                    color: #4b5563;
                }
                .order-meta-label {
                    font-size: 12px;
                    color: #6b7280;
                    text-transform: uppercase;
                    letter-spacing: .03em;
                    font-weight: 600;
                }
                .order-meta-value {
                    font-size: 14px;
                    font-weight: 500;
                    color: #111827;
                }
                .order-total-row {
                    font-size: 14px;
                }
                .order-total-row span:first-child {
                    color: #4b5563;
                }
                .order-total-highlight {
                    font-size: 20px;
                    font-weight: 700;
                    color: #dc2626;
                }
                .order-status-pill {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 6px 12px;
                    border-radius: 999px;
                    font-size: 13px;
                    font-weight: 600;
                }
                .order-status-pill i {
                    font-size: 16px;
                }
            </style>

            <section class="row">
                <div class="col-12">

                    <div class="row g-3">

                        <!-- CỘT TRÁI: THÔNG TIN + SẢN PHẨM -->
                        <div class="col-xl-8">

                            <!-- THÔNG TIN HÓA ĐƠN -->
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-receipt-cutoff me-2 text-primary"></i>
                                            Thông tin hóa đơn
                                        </h5>
                                        <small class="text-muted">Thông tin chung, khách hàng và người nhận</small>
                                    </div>
                                    <div>
                                        <!-- Trạng thái hóa đơn -->
                                        <span class="order-status-pill bg-success text-white"
                                              th:if="${hoaDon.trangThai == 'HOAN_THANH'}">
                                            <i class="bi bi-check-circle-fill"></i> Hoàn thành
                                        </span>
                                        <span class="order-status-pill bg-warning text-dark"
                                              th:if="${hoaDon.trangThai == 'CHO_XAC_NHAN'}">
                                            <i class="bi bi-hourglass-split"></i> Chờ xác nhận
                                        </span>
                                        <span class="order-status-pill bg-info text-dark"
                                              th:if="${hoaDon.trangThai == 'DANG_CHO_THANH_TOAN'}">
                                            <i class="bi bi-credit-card"></i> Đang chờ thanh toán
                                        </span>
                                        <span class="order-status-pill bg-info text-dark"
                                              th:if="${hoaDon.trangThai == 'DANG_GIAO'}">
                                            <i class="bi bi-truck"></i> Đang giao
                                        </span>
                                        <span class="order-status-pill bg-secondary text-white"
                                              th:if="${hoaDon.trangThai == 'DA_HUY'}">
                                            <i class="bi bi-x-circle-fill"></i> Đã hủy
                                        </span>
                                        <span class="badge bg-light text-dark"
                                              th:if="${hoaDon.trangThai != 'HOAN_THANH'
                                                     and hoaDon.trangThai != 'CHO_XAC_NHAN'
                                                     and hoaDon.trangThai != 'DANG_CHO_THANH_TOAN'
                                                     and hoaDon.trangThai != 'DANG_GIAO'
                                                     and hoaDon.trangThai != 'DA_HUY'}"
                                              th:text="${hoaDon.trangThai ?: '---'}">
                                            ---
                                        </span>
                                    </div>
                                </div>

                                <div class="card-body">
                                    <div class="row g-3">
                                        <!-- CỘT 1: MÃ, KÊNH, PT THANH TOÁN -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <div class="order-meta-label">Mã hóa đơn</div>
                                                <div class="order-meta-value" th:text="${hoaDon.ma ?: '-'}">HD-XXXX</div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Kênh bán</div>
                                                <div class="order-meta-value"
                                                     th:text="${
                                                            hoaDon.kenhBan == 'TAI_QUAY' ? 'Đơn hàng tại quầy'
                                                          : (hoaDon.kenhBan == 'WEB' ? 'Đơn hàng online' : '-')
                                                     }">
                                                    Đơn hàng online
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Phương thức thanh toán</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.phuongThucThanhToan ?: '---'}">
                                                    COD
                                                </div>
                                            </div>
                                        </div>

                                        <!-- CỘT 2: KHÁCH HÀNG + THỜI GIAN -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <div class="order-meta-label">Khách hàng (tài khoản)</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.tenKhachHang != null && !#strings.isEmpty(hoaDon.tenKhachHang)
                                                               ? hoaDon.tenKhachHang
                                                               : 'Khách hàng không đăng nhập'}">
                                                    Khách hàng không đăng nhập
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Nhân viên xử lý</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.tenNhanVien ?: '-'}">
                                                    -
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Ngày tạo</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.ngayTao != null
                                                                ? #temporals.format(hoaDon.ngayTao, 'dd/MM/yyyy HH:mm')
                                                                : '-'}">
                                                    01/01/2025 10:00
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Ghi chú</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.ghiChu != null && !#strings.isEmpty(hoaDon.ghiChu)
                                                                ? hoaDon.ghiChu
                                                                : '-'}">
                                                    -
                                                </div>
                                            </div>
                                        </div>

                                        <!-- CỘT 3: NGƯỜI NHẬN + LIÊN HỆ -->
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <div class="order-meta-label">Tên người nhận</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.tenNguoiNhan ?: '-'}">
                                                    Nguyễn Văn A
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Số điện thoại</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.sdt ?: '-'}">
                                                    0123456789
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Ngày sửa</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.ngaySua != null
                                                                ? #temporals.format(hoaDon.ngaySua, 'dd/MM/yyyy HH:mm')
                                                                : '-'}">
                                                    -
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <div class="order-meta-label">Ngày thanh toán</div>
                                                <div class="order-meta-value"
                                                     th:text="${hoaDon.ngayThanhToan != null
                                                                ? #temporals.format(hoaDon.ngayThanhToan, 'dd/MM/yyyy HH:mm')
                                                                : '-'}">
                                                    -
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ĐỊA CHỈ -->
                                        <div class="col-12">
                                            <div class="order-meta-label mb-1">Địa chỉ giao hàng</div>
                                            <div class="order-meta-value"
                                                 th:text="${hoaDon.diaChi != null && !#strings.isEmpty(hoaDon.diaChi)
                                                            ? hoaDon.diaChi
                                                            : '-'}">
                                                Địa chỉ giao hàng...
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- BẢNG SẢN PHẨM -->
                            <div class="card mb-3">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <div>
                                        <h5 class="card-title mb-0">
                                            <i class="bi bi-bag-check me-2 text-primary"></i>
                                            Sản phẩm trong hóa đơn
                                        </h5>
                                        <small class="text-muted">Danh sách sản phẩm, số lượng và đơn giá</small>
                                    </div>
                                </div>
                                <div class="card-body table-responsive">
                                    <table class="table table-sm table-striped table-hover align-middle mb-0">
                                        <thead class="table-light">
                                        <tr class="text-nowrap">
                                            <th>STT</th>
                                            <th>Ảnh</th>
                                            <th>Sản phẩm</th>
                                            <th>Thương hiệu</th>
                                            <th>Nồng độ</th>
                                            <th>SKU</th>
                                            <th class="text-center">Số lượng</th>
                                            <th class="text-end">Đơn giá</th>
                                            <th class="text-end">Thành tiền</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        <tr th:each="ct, iter : ${chiTietList}">
                                            <td th:text="${iter.index + 1}">1</td>

                                            <!-- Ảnh -->
                                            <td>
                                                <img th:if="${ct.sanPhamChiTiet != null and ct.sanPhamChiTiet.hinhAnh != null}"
                                                     th:src="@{'/images/uploads/' + ${ct.sanPhamChiTiet.hinhAnh}}"
                                                     class="rounded border"
                                                     style="max-width:50px; max-height:50px; object-fit:cover;">
                                                <span th:if="${ct.sanPhamChiTiet == null or ct.sanPhamChiTiet.hinhAnh == null}">-</span>
                                            </td>

                                            <!-- Tên + dung tích -->
                                            <td>
                                                <div class="fw-semibold"
                                                     th:text="${ct.sanPhamChiTiet != null && ct.sanPhamChiTiet.sanPham != null
                                                              ? ct.sanPhamChiTiet.sanPham.tenNuocHoa
                                                              : '-'}">
                                                    Tên nước hoa
                                                </div>
                                                <div class="text-muted small">
                                                    <span th:text="${
                                                         ct.sanPhamChiTiet != null
                                                         and ct.sanPhamChiTiet.dungTich != null
                                                         and ct.sanPhamChiTiet.dungTich.soMl != null
                                                       ? ct.sanPhamChiTiet.dungTich.soMl + ' ml'
                                                       : '-'
                                                    }">
                                                        50 ml
                                                    </span>
                                                </div>
                                            </td>

                                            <!-- Thương hiệu -->
                                            <td th:text="${
                                                   ct.sanPhamChiTiet != null
                                                   and ct.sanPhamChiTiet.sanPham != null
                                                   and ct.sanPhamChiTiet.sanPham.thuongHieu != null
                                                ? ct.sanPhamChiTiet.sanPham.thuongHieu.tenThuongHieu
                                                : '-'
                                            }">
                                                Thương hiệu
                                            </td>

                                            <!-- Nồng độ -->
                                            <td th:text="${
                                                   ct.sanPhamChiTiet != null
                                                   and ct.sanPhamChiTiet.nongDo != null
                                                ? ct.sanPhamChiTiet.nongDo.tenNongDo
                                                : '-'
                                            }">
                                                EDP
                                            </td>

                                            <!-- SKU -->
                                            <td th:text="${ct.sanPhamChiTiet != null && ct.sanPhamChiTiet.maSKU != null
                                                         ? ct.sanPhamChiTiet.maSKU : '-'}">
                                                SKU
                                            </td>

                                            <!-- Số lượng -->
                                            <td class="text-center" th:text="${ct.soLuong != null ? ct.soLuong : 0}">1</td>

                                            <!-- Đơn giá -->
                                            <td class="text-end fw-semibold "
                                                th:text="${ct.donGia != null
                                                         ? #numbers.formatDecimal(ct.donGia, 0, 'COMMA', 0, 'POINT') + ' ₫'
                                                         : '0 ₫'}">
                                                1.000.000 ₫
                                            </td>

                                            <!-- Thành tiền -->
                                            <td class="text-end fw-semibold text-danger"
                                                th:text="${ct.donGia != null and ct.soLuong != null
                                                         ? #numbers.formatDecimal(ct.donGia * ct.soLuong, 0, 'COMMA', 0, 'POINT') + ' ₫'
                                                         : '0 ₫'}">
                                                1.000.000 ₫
                                            </td>
                                        </tr>

                                        <tr th:if="${chiTietList == null or #lists.isEmpty(chiTietList)}">
                                            <td colspan="9" class="text-center text-muted py-3">
                                                Không có dữ liệu chi tiết hóa đơn.
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>

                        <!-- CỘT PHẢI: TỔNG TIỀN + THANH TOÁN -->
                        <div class="col-xl-4">

                            <!-- TỔNG QUAN THANH TOÁN -->
                            <div class="card order-summary-card mb-3">
                                <div class="card-header border-0 pb-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="card-title mb-1">
                                                <i class="bi bi-currency-exchange me-2 text-success"></i>
                                                Tổng quan thanh toán
                                            </h5>
                                            <small class="text-muted">
                                                Đối chiếu số tiền hóa đơn và trạng thái thanh toán.
                                            </small>
                                        </div>
                                        <div class="order-header-chip">
                                            <i class="bi bi-hash"></i>
                                            <span th:text="${hoaDon.ma ?: 'HD-XXXX'}">HD-XXXX</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">

                                    <div class="mb-3">
                                        <div class="order-total-row d-flex justify-content-between mb-1">
                                            <span>Tiền hàng</span>
                                            <span class="fw-semibold"
                                                  th:text="${#numbers.formatDecimal(hoaDon.tongTienHang ?: 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫
                                            </span>
                                        </div>
                                        <div class="order-total-row d-flex justify-content-between mb-1">
                                            <span>Giảm giá</span>
                                            <span class="fw-semibold text-danger"
                                                  th:text="${#numbers.formatDecimal(hoaDon.tienGiamGia ?: 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫
                                            </span>
                                        </div>
                                        <div class="order-total-row d-flex justify-content-between mb-1">
                                            <span>Phí ship</span>
                                            <span class="fw-semibold"
                                                  th:text="${#numbers.formatDecimal(hoaDon.phiShip ?: 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫
                                            </span>
                                        </div>



                                        <hr class="my-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="fw-semibold">TỔNG THANH TOÁN</span>
                                            <span class="order-total-highlight"
                                                  th:text="${#numbers.formatDecimal(hoaDon.tongThanhToan ?: 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                                                0 ₫
                                            </span>
                                        </div>
                                    </div>

                                    <!-- THÔNG TIN THANH TOÁN CHI TIẾT (nếu có entity ThanhToan) -->
                                    <div class="mt-3 small text-muted">
                                        <div class="mb-1">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Nếu có chênh lệch số liệu, vui lòng đối chiếu với lịch sử giao dịch hoặc chứng từ gốc.
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>

                    </div>

                </div>
            </section>
        </div>

        <!-- FOOTER -->
        <footer th:replace="~{/admin/fragments/footer :: footer}"></footer>
    </div>
</div>

<div th:replace="~{/admin/fragments/script :: script}"></div>
</body>
</html>
