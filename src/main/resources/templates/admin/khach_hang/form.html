<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/admin/fragments/head :: head}"></head>
<body>
<div class="wrapper">
    <aside th:replace="/admin/fragments/sidebar :: sidebar"></aside>
    <div id="main">
        <header th:replace="~{/admin/fragments/header :: header(${nguoiDung.id == null ? 'Thêm Khách hàng' : 'Cập nhật Khách hàng'})}"></header>
        <div class="page-heading">
            <h3 th:text="${nguoiDung.id == null ? 'Thêm Khách hàng' : 'Cập nhật Khách hàng'}"></h3>
        </div>

        <div class="page-content">
            <div class="card p-4 shadow-sm border-0">
                <form id="formKhachHang" th:action="@{/admin/khach-hang/save}" th:object="${nguoiDung}" method="post">

                    <input type="hidden" th:field="*{id}" id="userId">
                    <input type="hidden" id="oldEmail" th:value="${nguoiDung.email}">
                    <input type="hidden" name="vaiTro" value="KHACHHANG">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Mã khách hàng</label>
                            <input type="text" class="form-control" th:field="*{ma}" placeholder="Hệ thống tự tạo">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Họ tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" th:field="*{hoTen}" id="hoTen">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" th:field="*{email}" id="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Mật khẩu</label>
                            <input type="password"
                                   class="form-control"
                                   name="newPassword"
                                   id="matKhau"
                                   placeholder="Để trống nếu không muốn đổi"
                                   autocomplete="new-password">

                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Giới tính</label>
                            <select class="form-select" th:field="*{gioiTinh}">
                                <option value="1">Nam</option>
                                <option value="0">Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ngày sinh</label>
                            <input type="date" class="form-control" th:field="*{ngaySinh}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Số điện thoại</label>
                            <input type="text" class="form-control" th:field="*{sdt}" id="sdt">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Địa chỉ</label>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <select class="form-select" id="kh-province">
                                        <option value="">Tỉnh / Thành phố</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="kh-district">
                                        <option value="">Quận / Huyện</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <select class="form-select" id="kh-ward">
                                        <option value="">Phường / Xã</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <input type="text"
                                           class="form-control mt-2"
                                           id="kh-street"
                                           placeholder="Số nhà, tên đường...">
                                </div>
                            </div>

                            <!-- Hidden bind về NguoiDung.diaChi -->
                            <input type="hidden" th:field="*{diaChi}" id="kh-fullAddress">
                        </div>

                        <div class="col-md-4">
                            <label class="form-label fw-bold">Trạng thái</label>
                            <select class="form-select" th:field="*{trangThai}">
                                <option value="true">Hoạt động</option>
                                <option value="false">Khóa</option>
                            </select>
                        </div>
                    </div>


                    <div class="text-end mt-4">
                        <a href="/admin/khach-hang" class="btn btn-secondary me-2">
                            <i class="bi bi-arrow-left"></i> Quay lại
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Lưu dữ liệu
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <footer th:replace="/admin/fragments/footer :: footer"></footer>
    </div>
</div>

<script th:replace="/admin/fragments/script :: script"></script>


<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {

        // ========== ĐỊA CHỈ KHÁCH HÀNG (kh-*) ==========
        const khProvince = document.getElementById("kh-province");
        const khDistrict = document.getElementById("kh-district");
        const khWard     = document.getElementById("kh-ward");
        const khStreet   = document.getElementById("kh-street");
        const khFullAddr = document.getElementById("kh-fullAddress");

        function splitAddress(addr) {
            const parts = addr.split(',').map(p => p.trim()).filter(p => p.length > 0);
            let province = "", district = "", ward = "", street = "";
            if (parts.length >= 4) {
                province = parts[parts.length - 1];
                district = parts[parts.length - 2];
                ward     = parts[parts.length - 3];
                street   = parts.slice(0, parts.length - 3).join(", ");
            } else if (parts.length === 3) {
                province = parts[2];
                district = parts[1];
                street   = parts[0];
            } else if (parts.length === 2) {
                province = parts[1];
                street   = parts[0];
            } else if (parts.length === 1) {
                street   = parts[0];
            }
            return { province, district, ward, street };
        }

        function findOptionByName(select, targetName) {
            if (!select || !targetName) return null;
            const normTarget = targetName.toLowerCase();
            let found = null;
            Array.from(select.options).forEach(opt => {
                const name = (opt.textContent || "").toLowerCase();
                if (!name) return;
                if (name === normTarget || name.includes(normTarget) || normTarget.includes(name)) found = opt;
            });
            return found;
        }

        function updateKhFullAddress() {
            if (!khProvince || !khDistrict || !khWard || !khStreet || !khFullAddr) return;

            const p = khProvince.value ? khProvince.options[khProvince.selectedIndex].text.trim() : "";
            const d = khDistrict.value ? khDistrict.options[khDistrict.selectedIndex].text.trim() : "";
            const w = khWard.value     ? khWard.options[khWard.selectedIndex].text.trim() : "";
            const s = khStreet.value.trim();

            const arr = [];
            if (s) arr.push(s);
            if (w) arr.push(w);
            if (d) arr.push(d);
            if (p) arr.push(p);

            khFullAddr.value = arr.join(", ");
        }

        if (khProvince && khDistrict && khWard && khStreet && khFullAddr) {
            khDistrict.disabled = true;
            khWard.disabled     = true;

            const existingKhAddress = (khFullAddr.value || "").trim();

            function autoFillKhAddress() {
                if (!existingKhAddress) return;

                const parts = splitAddress(existingKhAddress);
                if (!parts.province) return;

                if (parts.street) khStreet.value = parts.street;

                const provOpt = findOptionByName(khProvince, parts.province);
                if (!provOpt) { updateKhFullAddress(); return; }

                khProvince.value = provOpt.value;
                khDistrict.disabled = false;

                fetch(`https://esgoo.net/api-tinhthanh/2/${provOpt.value}.htm`)
                    .then(r => r.json())
                    .then(data => {
                        khDistrict.innerHTML = '<option value="">Quận / Huyện</option>';
                        if (data.error === 0) data.data.forEach(item => khDistrict.add(new Option(item.full_name, item.id)));

                        if (!parts.district) { updateKhFullAddress(); return; }

                        const distOpt = findOptionByName(khDistrict, parts.district);
                        if (!distOpt) { updateKhFullAddress(); return; }

                        khDistrict.value = distOpt.value;
                        khWard.disabled = false;

                        return fetch(`https://esgoo.net/api-tinhthanh/3/${distOpt.value}.htm`)
                            .then(r => r.json())
                            .then(data2 => {
                                khWard.innerHTML = '<option value="">Phường / Xã</option>';
                                if (data2.error === 0) data2.data.forEach(item => khWard.add(new Option(item.full_name, item.id)));

                                if (parts.ward) {
                                    const wardOpt = findOptionByName(khWard, parts.ward);
                                    if (wardOpt) khWard.value = wardOpt.value;
                                }

                                updateKhFullAddress();
                            });
                    })
                    .catch(err => console.error("Lỗi auto-fill địa chỉ KH:", err));
            }

            fetch('https://esgoo.net/api-tinhthanh/1/0.htm')
                .then(r => r.json())
                .then(data => {
                    if (data.error === 0) data.data.forEach(item => khProvince.add(new Option(item.full_name, item.id)));
                    autoFillKhAddress();
                })
                .catch(err => console.error("Lỗi load tỉnh KH:", err));

            khProvince.addEventListener("change", function () {
                khDistrict.innerHTML = '<option value="">Quận / Huyện</option>';
                khWard.innerHTML     = '<option value="">Phường / Xã</option>';
                khWard.disabled      = true;

                if (this.value) {
                    khDistrict.disabled = false;
                    fetch(`https://esgoo.net/api-tinhthanh/2/${this.value}.htm`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.error === 0) data.data.forEach(item => khDistrict.add(new Option(item.full_name, item.id)));
                        })
                        .catch(err => console.error("Lỗi load huyện KH:", err));
                } else {
                    khDistrict.disabled = true;
                }
                updateKhFullAddress();
            });

            khDistrict.addEventListener("change", function () {
                khWard.innerHTML = '<option value="">Phường / Xã</option>';
                if (this.value) {
                    khWard.disabled = false;
                    fetch(`https://esgoo.net/api-tinhthanh/3/${this.value}.htm`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.error === 0) data.data.forEach(item => khWard.add(new Option(item.full_name, item.id)));
                        })
                        .catch(err => console.error("Lỗi load xã KH:", err));
                } else {
                    khWard.disabled = true;
                }
                updateKhFullAddress();
            });

            khWard.addEventListener("change", updateKhFullAddress);
            khStreet.addEventListener("input", updateKhFullAddress);
        }

        // ========== SWEETALERT FLASH MESSAGE (AN TOÀN KHI NULL) ==========
        const successMsg = /*[[${success}]]*/ '';
        const errorMsg   = /*[[${error}]]*/ '';

        if (successMsg && successMsg !== 'null') {
            Swal.fire({
                icon: 'success',
                title: 'Thành công!',
                text: successMsg,
                timer: 2000,
                showConfirmButton: false
            });
        }

        if (errorMsg && errorMsg !== 'null') {
            Swal.fire({
                icon: 'error',
                title: 'Lỗi!',
                text: errorMsg
            });
        }

        // ========== CONFIRM + VALIDATE + CHECK EMAIL ==========
        const form = document.getElementById("formKhachHang");

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const id       = (document.getElementById("userId").value || "").trim();
            const hoTen    = (document.getElementById("hoTen").value || "").trim();
            const email    = (document.getElementById("email").value || "").trim();
            const oldEmail = (document.getElementById("oldEmail").value || "").trim();
            const matKhau  = (document.getElementById("matKhau").value || "").trim();

            if (!hoTen) return Swal.fire("Thiếu thông tin", "Vui lòng nhập họ tên!", "warning");
            if (!email) return Swal.fire("Thiếu thông tin", "Vui lòng nhập email!", "warning");

            // thêm mới thì bắt buộc mật khẩu
            if (!id && !matKhau) {
                return Swal.fire("Thiếu thông tin", "Vui lòng tạo mật khẩu cho khách hàng mới!", "warning");
            }

            // check email trùng (thêm mới hoặc đổi email)
            if (!id || (id && email !== oldEmail)) {
                try {
                    const res = await fetch(`/admin/khach-hang/check-email?email=${encodeURIComponent(email)}`);
                    const exists = await res.json();
                    if (exists) return Swal.fire("Trùng lặp", "Email này đã có người sử dụng!", "error");
                } catch (err) {
                    return Swal.fire("Lỗi", "Không kiểm tra được email. Vui lòng thử lại!", "error");
                }
            }

            const result = await Swal.fire({
                title: "Xác nhận lưu?",
                text: "Thông tin khách hàng sẽ được cập nhật vào hệ thống.",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Đồng ý",
                cancelButtonText: "Hủy",
                reverseButtons: true
            });

            if (result.isConfirmed) {
                updateKhFullAddress(); // cập nhật hidden địa chỉ
                form.submit();
            }
        });
    });
</script>


</body>
</html>