<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/admin/fragments/head :: head}"></head>
<body>
<div class="wrapper">
    <aside th:replace="/admin/fragments/sidebar :: sidebar"></aside>
    <div id="main">
        <header th:replace="/admin/fragments/header :: header"></header>
        <div class="page-heading">
            <h3 th:text="${nguoiDung.id == null ? 'Thêm Khách hàng' : 'Cập nhật Khách hàng'}"></h3>
        </div>

        <div class="page-content">
            <div class="card p-4 shadow-sm border-0">
                <form id="formKhachHang" th:action="@{/admin/khach-hang/save}" th:object="${nguoiDung}" method="post">

                    <input type="hidden" th:field="*{id}" id="userId">
                    <input type="hidden" id="oldEmail" th:value="${nguoiDung.email}">
                    <input type="hidden" name="vaiTro" value="KHACHHANG">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Mã khách hàng</label>
                            <input type="text" class="form-control" th:field="*{ma}" placeholder="Hệ thống tự tạo">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Họ tên <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" th:field="*{hoTen}" id="hoTen">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Email <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" th:field="*{email}" id="email">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Mật khẩu</label>
                            <input type="password" class="form-control" th:field="*{matKhau}" id="matKhau"
                                   placeholder="Để trống nếu không muốn đổi">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Giới tính</label>
                            <select class="form-select" th:field="*{gioiTinh}">
                                <option value="1">Nam</option>
                                <option value="0">Nữ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Ngày sinh</label>
                            <input type="date" class="form-control" th:field="*{ngaySinh}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Số điện thoại</label>
                            <input type="text" class="form-control" th:field="*{sdt}" id="sdt">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Địa chỉ</label>
                            <input type="text" class="form-control" th:field="*{diaChi}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Trạng thái</label>
                            <select class="form-select" th:field="*{trangThai}">
                                <option value="true">Hoạt động</option>
                                <option value="false">Khóa</option>
                            </select>
                        </div>
                    </div>

                    <div class="text-end mt-4">
                        <a href="/admin/khach-hang" class="btn btn-secondary me-2">
                            <i class="bi bi-arrow-left"></i> Quay lại
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle"></i> Lưu dữ liệu
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <footer th:replace="/admin/fragments/footer :: footer"></footer>
    </div>
</div>

<script th:replace="/admin/fragments/script :: script"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("formKhachHang");

        // Thông báo từ Server
        const successMsg = [[${success}]];
        const errorMsg = [[${error}]];
        if (successMsg) Swal.fire({icon: 'success', title: 'Thành công', text: successMsg, timer: 1500, showConfirmButton: false});
        if (errorMsg) Swal.fire({icon: 'error', title: 'Lỗi', text: errorMsg});

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const id = document.getElementById("userId").value;
            const hoTen = document.getElementById("hoTen").value.trim();
            const email = document.getElementById("email").value.trim();
            const oldEmail = document.getElementById("oldEmail").value.trim();
            const matKhau = document.getElementById("matKhau").value.trim();

            if (!hoTen) return Swal.fire("Thiếu thông tin", "Vui lòng nhập họ tên!", "warning");
            if (!email) return Swal.fire("Thiếu thông tin", "Vui lòng nhập email!", "warning");

            // Validate pass: Nếu thêm mới (id rỗng) thì bắt buộc nhập pass
            if (!id && !matKhau) return Swal.fire("Thiếu thông tin", "Vui lòng tạo mật khẩu cho khách hàng mới!", "warning");

            // Check email trùng (nếu email bị thay đổi hoặc là thêm mới)
            if (!id || (id && email !== oldEmail)) {
                const res = await fetch(`/admin/khach-hang/check-email?email=${encodeURIComponent(email)}`);
                const exists = await res.json();
                if (exists) return Swal.fire("Trùng lặp", "Email này đã có người sử dụng!", "error");
            }

            Swal.fire({
                title: "Xác nhận lưu?",
                text: "Thông tin khách hàng sẽ được cập nhật vào hệ thống.",
                icon: "question",
                showCancelButton: true,
                confirmButtonText: "Đồng ý",
                cancelButtonText: "Hủy"
            }).then((result) => {
                if (result.isConfirmed) form.submit();
            });
        });
    });
</script>
</body>
</html>