<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{client/fragments/head :: head}">
    <link rel="stylesheet" th:href="@{/css/product.css}">
</head>
<body>

<div th:replace="~{client/fragments/header :: header}"></div>

<section class="container-fluid my-5 prod-dt">
    <div class="row">
        <div class="col-md-3 d-flex justify-content-center">
            <div class="product-image">
                <div id="product-gallery" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <img th:src="@{'/images/uploads/' + ${sanPhamChiTiet.hinhAnh}}" class="d-block w-100" alt="Ảnh sản phẩm">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <h1 th:text="${sanPhamChiTiet.tenSanPham}">Tên sản phẩm</h1>

            <p class="product-price" id="product-price" th:text="${#numbers.formatDecimal(sanPhamChiTiet.giaBan, 0, 'POINT', 0, 'NONE')} + ' ₫'">Giá sản phẩm</p>

            <div class="product-description">
                <h5>Mô tả sản phẩm</h5>
                <p th:text="${sanPhamChiTiet.moTa}">Mô tả sản phẩm</p>
            </div>

            <form id="addToCartForm">

                <input type="hidden" id="selectedSanPhamChiTietId" th:value="${sanPhamChiTiet.id}">

                <div class="dung-tich-options">
                    <label th:each="option : ${options}" class="dung-tich-label">
                        <input type="radio" name="dung-tich"
                               th:value="${option.soMl}"
                               th:checked="${option.soMl == selectedDungTich}"
                               th:onchange="|updatePrice(${option.soMl})|"
                               class="dung-tich-radio">
                        <span class="dung-tich-text" th:text="${option.soMl} + 'ml'"></span>
                    </label>
                </div>

                <div class="my-3">
                    <label for="quantityInput" class="form-label fw-bold">Số lượng:</label>
                    <input type="number" id="quantityInput" class="form-control"
                           value="1" min="1"
                           th:max="${sanPhamChiTiet.soLuongTon}"
                           th:disabled="${sanPhamChiTiet.soLuongTon <= 0}"
                           style="width: 100px;">
                </div>

                <div class="add-to-cart mt-4">
                    <button id="addToCartButton" class="btn btn-primary w-100" type="submit"
                            th:disabled="${sanPhamChiTiet.soLuongTon <= 0}"
                            style="padding: 12px 20px;">
                        <i class="bi bi-cart-plus"></i>
                        <span th:if="${sanPhamChiTiet.soLuongTon > 0}">Thêm vào giỏ hàng</span>
                        <span th:if="${sanPhamChiTiet.soLuongTon <= 0}">Hết hàng</span>
                    </button>
                </div>

            </form>
        </div>

        <div class="col-md-3">
            <div class="product-table">
                <h5>Thông tin sản phẩm</h5>
                <ul class="info-list">
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/thuong-hieu-icon.png" alt="Thương hiệu">
                        </div>
                        <p class="txt">Thương hiệu:
                            <a class="brand-link2" th:text="${sanPhamChiTiet.tenThuongHieu}">Thương hiệu</a>
                        </p>
                    </li>
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/nong-do-icon.png" alt="Nồng độ">
                        </div>
                        <p class="txt">Nồng độ:
                            <span th:text="${sanPhamChiTiet.tenNongDo}">Nồng độ</span>
                        </p>
                    </li>
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/luu-mui-icon.png" alt="Độ lưu mùi">
                        </div>
                        <p class="txt">Nhóm hương:
                            <span th:text="${sanPhamChiTiet.tenNhomHuong}">Nhóm hương</span>
                        </p>
                    </li>
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/toa-huong-icon.png" alt="Độ tỏa hương">
                        </div>
                        <p class="txt">Mùa thích hợp:
                            <span th:text="${sanPhamChiTiet.tenMuaThichHop}">Mùa thích hợp</span>
                        </p>
                    </li>
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/gioi-tinh-icon.png" alt="Giới tính">
                        </div>
                        <p class="txt">Giới tính:
                            <span th:text="${sanPhamChiTiet.tenLoaiNuocHoa}">Giới tính</span>
                        </p>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</section>

<div th:replace="~{client/fragments/footer :: footer}"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <script th:inline="javascript">

    var idSanPham = /*[[${idSanPham}]]*/ null;

    function formatPrice(price) {
        if (price == null || isNaN(price)) return "N/A";
        return parseFloat(price).toLocaleString("vi-VN") + " ₫";
    }

    // Hàm cập nhật giá VÀ TỒN KHO
    function updatePrice(soMl) {
        if (!soMl) return;

        // Lấy các phần tử DOM
        const priceEl = document.getElementById('product-price');
        const hiddenIdEl = document.getElementById('selectedSanPhamChiTietId');
        const qtyInputEl = document.getElementById('quantityInput');
        const submitBtn = document.getElementById('addToCartButton');
        const btnText = submitBtn.querySelector('span');

        // Gọi API của SanPhamClientController (đã được sửa để trả về soLuongTon)
        fetch(`/san-pham/${idSanPham}/gia?soMl=${soMl}`)
            .then(response => response.json())
            .then(data => {
                if(data.giaBan && data.idSpct) {

                    // 1. Cập nhật giá
                    priceEl.innerText = formatPrice(data.giaBan);

                    // 2. Cập nhật ID (Sửa lỗi "undefined")
                    hiddenIdEl.value = data.idSpct;

                    // 3. Cập nhật Tồn Kho (Quan trọng)
                    var stock = parseInt(data.soLuongTon || 0);
                    qtyInputEl.max = stock;

                    // 4. Cập nhật trạng thái
                    if (stock <= 0) {
                        qtyInputEl.value = 0; // Đặt giá trị là 0 khi hết hàng
                        qtyInputEl.disabled = true;
                        submitBtn.disabled = true;
                        if (btnText) btnText.innerText = 'Hết hàng';
                    } else {
                        qtyInputEl.value = 1; // Reset số lượng về 1
                        qtyInputEl.disabled = false;
                        submitBtn.disabled = false;
                        if (btnText) btnText.innerText = 'Thêm vào giỏ hàng';
                    }
                }
            })
            .catch(error => console.error('Lỗi khi cập nhật giá:', error));
    }

    // Tự động chạy khi tải trang (Đã sửa lại logic)
    document.addEventListener("DOMContentLoaded", function() {
        var defaultInput = document.querySelector('input[name="dung-tich"]:checked');
        if (defaultInput) {
             // Không cần gọi updatePrice, vì Thymeleaf đã render giá trị ban đầu chính xác
        } else {
            // Nếu không có gì được check, chọn cái đầu tiên (nếu có)
             var firstInput = document.querySelector('input[name="dung-tich"]');
             if(firstInput) {
                firstInput.checked = true;
                updatePrice(firstInput.value);
             }
        }
    });
</script>

<script th:src="@{/js/cart-ajax.js}"></script>
</body>
</html>