<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="client/fragments/head :: head">
    <link rel="stylesheet" th:href="@{/css/product.css}">
</head>
<body>

<div th:replace="client/fragments/header :: header"></div>

<section class="container-fluid my-5 prod-dt">
    <div class="row">
        <div class="col-md-3 d-flex justify-content-center">
            <div class="product-image">
                <div id="product-gallery" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        <div class="carousel-item active">
                            <img th:src="@{'/images/uploads/' + ${sanPhamChiTiet.hinhAnh}}" class="d-block w-100" alt="Ảnh sản phẩm">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <h1 th:text="${sanPhamChiTiet.tenSanPham}">Tên sản phẩm</h1>

            <p class="product-price" id="product-price" th:text="${#numbers.formatDecimal(sanPhamChiTiet.giaBan, 0, 'POINT', 0, 'NONE')} + ' ₫'">Giá sản phẩm</p>

            <div class="product-description">
                <h5>Mô tả sản phẩm</h5>
                <p th:text="${sanPhamChiTiet.moTa}">Mô tả sản phẩm</p>
            </div>

            <form id="addToCartForm">

                <input type="hidden" id="selectedSanPhamChiTietId"
                       th:value="${sanPhamChiTiet.id}"> <div class="dung-tich-options">
                <label th:each="option : ${options}" class="dung-tich-label">
                    <input type="radio" name="dung-tich"
                           th:value="${option.soMl}"
                           th:checked="${option.soMl == selectedDungTich}"
                           th:onchange="|updatePrice(${option.soMl})|"
                           class="dung-tich-radio">
                    <span class="dung-tich-text" th:text="${option.soMl} + 'ml'"></span>
                </label>
            </div>

                <div class="my-3">
                    <label for="quantityInput" class="form-label fw-bold">Số lượng:</label>
                    <input type="number" id="quantityInput" class="form-control"
                           value="1" min="1" max="10" style="width: 100px;">
                </div>

                <div class="add-to-cart mt-4">
                    <button class="btn btn-primary w-100" type="submit" style="padding: 12px 20px;">
                        <i class="bi bi-cart-plus"></i> Thêm vào giỏ hàng
                    </button>
                </div>

            </form>
        </div>

        <div class="col-md-3">
            <div class="product-table">
                <h5>Thông tin sản phẩm</h5>
                <ul class="info-list">
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/thuong-hieu-icon.png" alt="Thương hiệu">
                        </div>
                        <p class="txt">Thương hiệu:
                            <a class="brand-link2" th:text="${sanPhamChiTiet.tenThuongHieu}">Thương hiệu</a>
                        </p>
                    </li>
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/nong-do-icon.png" alt="Nồng độ">
                        </div>
                        <p class="txt">Nồng độ:
                            <span th:text="${sanPhamChiTiet.tenNongDo}">Nồng độ</span>
                        </p>
                    </li>
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/luu-mui-icon.png" alt="Độ lưu mùi">
                        </div>
                        <p class="txt">Nhóm hương:
                            <span th:text="${sanPhamChiTiet.tenNhomHuong}">Nhóm hương</span>
                        </p>
                    </li>
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/toa-huong-icon.png" alt="Độ tỏa hương">
                        </div>
                        <p class="txt">Mùa thích hợp:
                            <span th:text="${sanPhamChiTiet.tenMuaThichHop}">Mùa thích hợp</span>
                        </p>
                    </li>
                    <li class="info-item">
                        <div class="ic-info">
                            <img src="/images/gioi-tinh-icon.png" alt="Giới tính">
                        </div>
                        <p class="txt">Giới tính:
                            <span th:text="${sanPhamChiTiet.tenLoaiNuocHoa}">Giới tính</span>
                        </p>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</section>

<div th:replace="client/fragments/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // Lấy idSanPham từ Model (để dùng trong fetch URL)
    // Cú pháp [[...]] của Thymeleaf sẽ chèn giá trị Java vào JavaScript
    var idSanPham = /*[[${idSanPham}]]*/ null;

    // Hàm format giá (Giữ nguyên của bạn)
    function formatPrice(price) {
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    // Hàm cập nhật giá (ĐÃ SỬA)
    function updatePrice(soMl) {
        // Gọi API của SanPhamClientController
        fetch(`/san-pham/${idSanPham}/gia?soMl=${soMl}`)
            .then(response => response.json())
            .then(data => {
                if(data.giaBan) {
                    // 1. Cập nhật giá hiển thị cho người dùng
                    var formattedGia = formatPrice(data.giaBan);
                    document.getElementById('product-price').innerText = formattedGia + ' ₫';

                    // 2. CẬP NHẬT INPUT ẨN (Rất quan trọng)
                    // (API của bạn trả về 'idSpct')
                    document.getElementById('selectedSanPhamChiTietId').value = data.idSpct;
                }
            })
            .catch(error => console.error('Lỗi khi cập nhật giá:', error));
    }

    // Code window.onload của bạn (Giữ nguyên)
    window.onload = function() {
        var defaultInput = document.querySelector('input[name="dung-tich"]:checked');
        if (defaultInput) {
            updatePrice(defaultInput.value);
        }
    };
</script>

<script th:src="@{/js/cart-ajax.js}"></script>

</body>
</html>