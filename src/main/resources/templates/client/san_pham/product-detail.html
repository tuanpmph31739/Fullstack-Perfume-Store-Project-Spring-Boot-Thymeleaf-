<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="client/fragments/head :: head">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${sanPhamChiTiet.tenSanPham} + ' | Fperfume'">Chi ti·∫øt s·∫£n ph·∫©m</title>

    <!-- CSRF cho JS c≈© -->

</head>
<body>

<!-- Header -->
<div th:replace="~{client/fragments/header :: header}"></div>

<main class="container pd-wrap">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb small">
            <li class="breadcrumb-item"><a th:href="@{/}">Trang ch·ªß</a></li>
            <li class="breadcrumb-item">
                <a th:if="${sanPhamChiTiet.idThuongHieu != null}"
                   th:href="@{/thuong-hieu/{slug}(slug=${sanPhamChiTiet.slugThuongHieu})}"
                   th:text="${sanPhamChiTiet.tenThuongHieu}">Th∆∞∆°ng hi·ªáu</a>
                <span th:unless="${sanPhamChiTiet.idThuongHieu != null}"
                      th:text="${sanPhamChiTiet.tenThuongHieu}">Th∆∞∆°ng hi·ªáu</span>
            </li>
            <li class="breadcrumb-item active" aria-current="page"
                th:text="${sanPhamChiTiet.tenSanPham}">T√™n s·∫£n ph·∫©m</li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- LEFT: Gallery -->
        <div class="col-lg-4">
            <div class="pd-gallery">
                <div class="pd-main-img">
                    <img id="mainImage" th:src="@{'/images/uploads/' + ${sanPhamChiTiet.hinhAnh}}" alt="·∫¢nh s·∫£n ph·∫©m" />
                </div>
                <div class="pd-thumbs" id="thumbs">
                    <button type="button" class="active">
                        <img th:src="@{'/images/uploads/' + ${sanPhamChiTiet.hinhAnh}}" alt="thumb"/>
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <h1 class="pd-title" th:text="${sanPhamChiTiet.tenSanPham}">T√™n s·∫£n ph·∫©m</h1>
            <div class="pd-meta d-flex align-items-center gap-2">
        <span class="text-warning">
          <i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i><i class="bi bi-star-fill"></i>
        </span>
                <span>(<span th:text="${soDanhGia ?: 0}">0</span> ƒë√°nh gi√°)</span>
                <span class="ms-2 badge text-bg-light" th:text="${sanPhamChiTiet.tenLoaiNuocHoa}">Unisex</span>
            </div>

            <!-- GI·ªÆ id ƒë·ªÉ JS c≈© ƒë·ªçc -->
            <div class="pd-price" id="product-price"
                 th:text="${#numbers.formatDecimal(sanPhamChiTiet.giaBan, 0, 'POINT', 0, 'NONE')} + ' ‚Ç´'">0 ‚Ç´</div>

            <!-- Variants (Dung t√≠ch) ‚Äî GI·ªÆ name/ onchange cho JS c≈© -->
            <div class="pd-variants mb-3">
                <div class="fw-semibold mb-2">Dung t√≠ch</div>
                <div class="d-flex flex-wrap gap-2">
                    <label th:each="option : ${options}" class="pill"
                           th:classappend="${option.soMl == selectedDungTich} ? ' active'">
                        <input type="radio" name="dung-tich" class="dung-tich-radio"
                               th:value="${option.soMl}"
                               th:checked="${option.soMl == selectedDungTich}"
                               th:onchange="|updatePrice(${option.soMl})|">
                        <span th:text="${option.soMl} + 'ml'">50ml</span>
                    </label>
                </div>
            </div>

            <!-- Quantity + Add to cart ‚Äî GI·ªÆ ID/NAME ƒë√∫ng ƒë·ªÉ JS c≈© b·∫Øt ƒë∆∞·ª£c -->
            <form id="addToCartForm">
                <input type="hidden" id="selectedSanPhamChiTietId" th:value="${sanPhamChiTiet.id}" />
                <input type="hidden" id="redirectCheckout" value="false"/>
                <div class="d-flex align-items-center justify-content-between">
                    <div class="qty-group">
                        <button class="btn btn-sm btn-outline-secondary" type="button" id="minusBtn"><i class="bi bi-dash"></i></button>
                        <input type="number" id="quantityInput" class="form-control" value="1" min="1"
                               th:max="${sanPhamChiTiet.soLuongTon}" th:disabled="${sanPhamChiTiet.soLuongTon <= 0}"
                               style="width:90px" />
                        <button class="btn btn-sm btn-outline-secondary" type="button" id="plusBtn"><i class="bi bi-plus"></i></button>
                    </div>
                    <div class="text-muted small">C√≤n <b id="stockText" th:text="${sanPhamChiTiet.soLuongTon}">0</b> SP</div>
                </div>

                <div class="mt-3 d-grid gap-2">
                    <!-- GI·ªÆ span n·ªôi b·ªô ƒë·ªÉ JS thay ƒë·ªïi text -->
                    <button id="addToCartButton" class="btn btn-buy btn-lg" type="submit"
                            th:disabled="${sanPhamChiTiet.soLuongTon <= 0}">
                        <i class="bi bi-bag-plus"></i>
                        <span th:if="${sanPhamChiTiet.soLuongTon > 0}">Th√™m v√†o gi·ªè h√†ng</span>
                        <span th:if="${sanPhamChiTiet.soLuongTon <= 0}">H·∫øt h√†ng</span>
                    </button>

<!--                     (t√πy) Link mua ngay n·∫øu b·∫°n d√πng-->
                    <button type="button"
                            id="buyNowButton"
                            class="btn btn-outline-dark btn-lg w-100">
                        Mua ngay
                    </button>

                    <div class="hotline d-flex align-items-center gap-2 justify-content-center">
                        <i class="bi bi-telephone"></i><span>HOTLINE</span><b>0397682148</b><span class="text-muted">(9:00 - 22:00)</span>
                    </div>
                </div>
            </form>

            <!-- Social -->
            <div class="d-flex align-items-center gap-3 mt-3 text-muted">
                <span class="small">Chia s·∫ª:</span>
                <a href="#" class="text-muted"><i class="bi bi-facebook"></i></a>
                <a href="#" class="text-muted"><i class="bi bi-instagram"></i></a>
                <a href="#" class="text-muted"><i class="bi bi-tiktok"></i></a>
                <button class="btn btn-sm btn-link text-muted" type="button" id="btnWish"><i class="bi bi-heart"></i> Y√™u th√≠ch</button>
            </div>
        </div>

        <!-- RIGHT: Info table -->
        <div class="col-lg-4">
            <aside class="pd-info">
                <h5 class="mb-3">Th√¥ng tin s·∫£n ph·∫©m</h5>
                <ul class="info-list">
                    <li class="info-item">
                        <div class="ic"><img src="/images/thuong-hieu-icon.png" alt="Brand" style="width:20px;height:20px"></div>
                        <div>Th∆∞∆°ng hi·ªáu:
                            <a class="text-decoration-none"
                               th:if="${sanPhamChiTiet.idThuongHieu != null}"
                               th:href="@{/thuong-hieu/{slug}(slug=${sanPhamChiTiet.slugThuongHieu})}"
                               th:text="${sanPhamChiTiet.tenThuongHieu}">Brand</a>
                            <span th:unless="${sanPhamChiTiet.idThuongHieu != null}"
                                  th:text="${sanPhamChiTiet.tenThuongHieu}">Brand</span>
                        </div>
                    </li>
                    <li class="info-item">
                        <div class="ic"><img src="/images/nong-do-icon.png" alt="Concentration" style="width:20px;height:20px"></div>
                        <div>N·ªìng ƒë·ªô: <span th:text="${sanPhamChiTiet.tenNongDo}">Eau De Parfum</span></div>
                    </li>
                    <li class="info-item">
                        <div class="ic"><img src="/images/gioi-tinh-icon.png" alt="Gender" style="width:20px;height:20px"></div>
                        <div>Gi·ªõi t√≠nh: <span th:text="${sanPhamChiTiet.tenLoaiNuocHoa}">Unisex</span></div>
                    </li>
                    <li class="info-item">
                        <div class="ic"><i class="bi bi-upc-scan"></i></div>
                        <div>SKU: <span th:text="${sanPhamChiTiet.maSKU}"></span></div>
                    </li>
                </ul>
            </aside>
        </div>
    </div>

    <!-- Tabs m√¥ t·∫£ (t√πy ch·ªçn) -->
    <section class="pd-tabs">
        <!-- Tabs -->
        <ul class="nav nav-underline pd-tabs-nav" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pane-desc" type="button" role="tab">
                    M√î T·∫¢ S·∫¢N PH·∫®M
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pane-usage" type="button" role="tab">
                    S·ª¨ D·ª§NG &amp; B·∫¢O QU·∫¢N
                </button>
            </li>
        </ul>

        <!-- Content -->
        <div class="tab-content tab-content-product">
            <!-- M√î T·∫¢ -->
            <div class="tab-pane fade show active" id="pane-desc" role="tabpanel">
                <div class="pd-box">
                    <div class="pd-desc-lead"
                         th:utext="'<strong>Nh√≥m h∆∞∆°ng ch√≠nh:</strong> ' + ${#strings.replace(sanPhamChiTiet.tenNhomHuong, '\n', '<br/>')}">
                        <strong>Nh√≥m h∆∞∆°ng ch√≠nh:</strong> H∆∞∆°ng G·ªó (Woody)
                    </div>
                    <div class="pd-desc-body"
                         th:utext="${#strings.replace(sanPhamChiTiet.moTa, '\n', '<br/>')}">
                        M√¥ t·∫£ s·∫£n ph·∫©m...
                    </div>
                </div>
            </div>

            <!-- S·ª¨ D·ª§NG & B·∫¢O QU·∫¢N -->
            <div class="tab-pane fade" id="pane-usage" role="tabpanel">
                <div class="pd-box">
                    <h5>C√ÅCH S·ª¨ D·ª§NG:</h5>
                    <ul class="pd-list">
                        <li>C√°c v·ªã tr√≠ ƒë∆∞·ª£c ∆∞u ti√™n ti·∫øp x√∫c l√† c·ªï tay, khu·ª∑u tay, sau tai, g√°y, c·ªï tr∆∞·ªõc.</li>
                        <li>Sau khi x·ªãt n∆∞·ªõc hoa l√™n c∆° th·ªÉ, tr√°nh d√πng tay ch√† x√°t ho·∫∑c l√†m kh√¥ da b·∫±ng nh·ªØng v·∫≠t d·ª•ng kh√°c, ƒëi·ªÅu n√†y ph√° v·ª° c√°c t·∫ßng h∆∞∆°ng trong n∆∞·ªõc hoa, khi·∫øn n√≥ c√≥ th·ªÉ thay ƒë·ªïi m√πi h∆∞∆°ng ho·∫∑c bay m√πi nhanh h∆°n.</li>
                        <li>ƒê·ªÉ chai n∆∞·ªõc hoa c√°ch v·ªã tr√≠ c·∫ßn d√πng n∆∞·ªõc hoa trong kho·∫£ng 15-20cm v√† x·ªãt m·∫°nh, d·ª©t kho√°t ƒë·ªÉ m·∫≠t ƒë·ªô ph·ªß c·ªßa n∆∞·ªõc hoa ƒë∆∞·ª£c r·ªông nh·∫•t, tƒÉng ƒë·ªô b√°m t·ªèa tr√™n da c·ªßa b·∫°n.</li>
                        <li>N∆∞·ªõc hoa c√≥ th·ªÉ b√°m t·ªët hay kh√¥ng t·ªët t√πy thu·ªôc v√†o th·ªùi gian, kh√¥ng gian, c∆° ƒë·ªãa, ch·∫ø ƒë·ªô sinh ho·∫°t, ƒÉn u·ªëng c·ªßa b·∫°n.</li>
                        <li>B·∫°n n√™n mang theo n∆∞·ªõc hoa b√™n m√¨nh ho·∫∑c trang b·ªã nh·ªØng m·∫´u nh·ªè ti·ªán d·ª•ng.</li>
                    </ul>
                    <br>
                    <h5>C√ÅCH B·∫¢O QU·∫¢N:</h5>
                    <ul class="pd-list">
                        <li>N∆∞·ªõc hoa th∆∞·ªùng kh√¥ng c√≥ h·∫°n s·ª≠ d·ª•ng. Tuy nhi√™n, ·ªü m·ªôt s·ªë lo·∫°i n∆∞·ªõc h·∫°n s·ª≠ d·ª•ng ƒë∆∞·ª£c ch√∫ th√≠ch l√† t·ª´ 24 ƒë·∫øn 36 th√°ng, v√† t√≠nh t·ª´ ng√†y b·∫°n m·ªü s·∫£n ph·∫©m v√† s·ª≠ d·ª•ng l·∫ßn ƒë·∫ßu ti√™n.</li>
                        <li>N√™n b·∫£o qu·∫£n n∆∞·ªõc hoa ·ªü nh·ªØng n∆°i kh√¥ tho√°ng, m√°t m·∫ª, tr√°nh n·∫Øng, n√≥ng ho·∫∑c qu√° l·∫°nh, l∆∞u √Ω kh√¥ng ƒë·ªÉ n∆∞·ªõc hoa trong c·ªëp xe, nh·ªØng n∆°i c√≥ nhi·ªát ƒë·ªô n√≥ng l·∫°nh th·∫•t th∆∞·ªùng‚Ä¶</li>
                        <li>H·∫°n s·ª≠ d·ª•ng: In tr√™n bao b√¨ s·∫£n ph·∫©m</li>
                        <li>Ng√†y s·∫£n xu·∫•t: In tr√™n bao b√¨ s·∫£n ph·∫©m</li>
                        <li>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng v√† l·ª±a ch·ªçn F Perfume. Ch√∫ng t√¥i cam k·∫øt s·∫Ω mang ƒë·∫øn nh·ªØng s·∫£n ph·∫©m ch√≠nh h√£ng v√† ch·∫•t l∆∞·ª£ng tuy·ªát v·ªùi cho b·∫°n.</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>
    <!-- S·∫¢N PH·∫®M LI√äN QUAN - 4 s·∫£n ph·∫©m / slide -->
    <section class="mt-5"
             th:if="${relatedChunks != null and !relatedChunks.isEmpty()}">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">S·∫£n ph·∫©m li√™n quan</h4>

            <!-- Ch·ªâ hi·ªán n√∫t n·∫øu c√≥ h∆°n 1 slide -->
            <div class="d-flex gap-2"
                 th:if="${#lists.size(relatedChunks) > 1}">
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        data-bs-target="#relatedCarousel"
                        data-bs-slide="prev">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        data-bs-target="#relatedCarousel"
                        data-bs-slide="next">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <div id="relatedCarousel" class="carousel slide" data-bs-ride="false">
            <div class="carousel-inner">

                <!-- M·ªói chunk = 1 slide -->
                <div class="carousel-item"
                     th:each="chunk, iter : ${relatedChunks}"
                     th:classappend="${iter.index == 0} ? ' active'">
                    <div class="row g-3">
                        <!-- Trong 1 slide, l·∫∑p 4 s·∫£n ph·∫©m -->
                        <div class="col-6 col-md-3"
                             th:each="sp : ${chunk}">
                            <div class="card h-100 border-0 shadow-sm product-card">
                                <a th:href="@{/san-pham/{id}(id=${sp.id})}"
                                   class="text-decoration-none text-dark d-flex flex-column h-100">
                                    <div class="ratio ratio-1x1">
                                        <img th:src="@{'/images/uploads/' + ${sp.hinhAnh}}"
                                             th:alt="${sp.tenSanPham}"
                                             class="card-img-top object-fit-cover">
                                    </div>
                                    <div class="card-body p-2">
                                        <h6 class="mb-1 text-truncate"
                                            th:text="${sp.tenSanPham}">T√™n s·∫£n ph·∫©m</h6>
                                        <div class="small text-muted text-truncate"
                                             th:text="${sp.tenThuongHieu}">Th∆∞∆°ng hi·ªáu</div>
                                        <div class="fw-semibold text-primary mt-1"
                                             th:text="${#numbers.formatDecimal(sp.giaBan, 0, 'POINT', 0, 'NONE')} + ' ‚Ç´'">
                                            0 ‚Ç´
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- S·∫¢N PH·∫®M LI√äN QUAN - 4 s·∫£n ph·∫©m / slide -->
    <section class="mt-5"
             th:if="${relatedChunks != null and !relatedChunks.isEmpty()}">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">S·∫£n ph·∫©m li√™n quan</h4>

            <!-- Ch·ªâ hi·ªán n√∫t n·∫øu c√≥ h∆°n 1 slide -->
            <div class="d-flex gap-2"
                 th:if="${#lists.size(relatedChunks) > 1}">
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        data-bs-target="#relatedCarousel"
                        data-bs-slide="prev">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary"
                        type="button"
                        data-bs-target="#relatedCarousel"
                        data-bs-slide="next">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
        </div>

        <div id="relatedCarousel" class="carousel slide" data-bs-ride="false">
            <div class="carousel-inner">

                <!-- M·ªói chunk = 1 slide -->
                <div class="carousel-item"
                     th:each="chunk, iter : ${relatedChunks}"
                     th:classappend="${iter.index == 0} ? ' active'">
                    <div class="row g-3">
                        <!-- Trong 1 slide, l·∫∑p 4 s·∫£n ph·∫©m -->
                        <div class="col-6 col-md-3"
                             th:each="sp : ${chunk}">
                            <div class="card h-100 border-0 shadow-sm product-card" style="text-align: center">
                                <a th:href="@{/san-pham/{id}(id=${sp.id})}"
                                   class="text-decoration-none text-dark d-flex flex-column h-100">
                                    <div class="ratio ratio-1x1">
                                        <img th:src="@{'/images/uploads/' + ${sp.hinhAnh}}"
                                             th:alt="${sp.tenSanPham}"
                                             class="card-img-top object-fit-cover">
                                    </div>
                                    <div class="card-body p-2">
                                        <h6 class="mb-1 text-truncate"
                                            th:text="${sp.tenSanPham}">T√™n s·∫£n ph·∫©m</h6>
                                        <div class="small text-muted text-truncate"
                                             th:text="${sp.tenThuongHieu}">Th∆∞∆°ng hi·ªáu</div>
                                        <div class="fw-semibold mt-1" style="color: #A68A79FF"
                                             th:text="${#numbers.formatDecimal(sp.giaBan, 0, 'POINT', 0, 'NONE')} + ' ‚Ç´'">
                                            0 ‚Ç´
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </section>

</main>

<!-- Footer -->
<div th:replace="~{client/fragments/footer :: footer}"></div>

<!-- Vendor JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    document.addEventListener('DOMContentLoaded', function(){
        const minusBtn = document.getElementById('minusBtn');
        const plusBtn = document.getElementById('plusBtn');
        const qty = document.getElementById('quantityInput');
        minusBtn?.addEventListener('click',()=>{ const min=parseInt(qty.min||1); qty.value=Math.max(min,(parseInt(qty.value||1)-1)); });
        plusBtn?.addEventListener('click',()=>{ const max=parseInt(qty.max||999999); qty.value=Math.min(max,(parseInt(qty.value||1)+1)); });
        // hi·ªÉn th·ªã active pill
        document.querySelectorAll('.pd-variants .pill input').forEach(r=>{
            r.addEventListener('change', ()=>{
                document.querySelectorAll('.pd-variants .pill').forEach(l=>l.classList.remove('active'));
                r.closest('.pill')?.classList.add('active');
            });
        });
    });
</script>

<script th:src="@{/js/cart-ajax.js}"></script>

<script th:inline="javascript">
    var idSanPham = /*[[${idSanPham}]]*/ null;
    function formatPrice(price){ if(price==null||isNaN(price)) return "N/A"; return parseFloat(price).toLocaleString("vi-VN")+" ‚Ç´"; }
    function updatePrice(soMl){
        if(!soMl) return;
        const priceEl=document.getElementById('product-price');
        const hiddenIdEl=document.getElementById('selectedSanPhamChiTietId');
        const qtyInputEl=document.getElementById('quantityInput');
        const submitBtn=document.getElementById('addToCartButton');
        const btnText=submitBtn.querySelector('span');
        fetch(`/san-pham/${idSanPham}/gia?soMl=${soMl}`)
            .then(r=>r.json())
            .then(data=>{
                if(data.giaBan && data.idSpct){
                    priceEl.innerText = formatPrice(data.giaBan);
                    hiddenIdEl.value = data.idSpct;
                    const stock = parseInt(data.soLuongTon||0);
                    qtyInputEl.max = stock;

                    // üëá TH√äM ƒêO·∫†N N√ÄY
                    const stockTextEl = document.getElementById('stockText');
                    if (stockTextEl) {
                        stockTextEl.innerText = stock;
                    }

                    if (stock<=0){
                        qtyInputEl.value=0; qtyInputEl.disabled=true; submitBtn.disabled=true;
                        if(btnText) btnText.innerText='H·∫øt h√†ng';
                    } else {
                        if(parseInt(qtyInputEl.value)<1) qtyInputEl.value=1;
                        qtyInputEl.disabled=false; submitBtn.disabled=false;
                        if(btnText) btnText.innerText='Th√™m v√†o gi·ªè h√†ng';
                    }
                }
            })
            .catch(err=>console.error('L·ªói c·∫≠p nh·∫≠t gi√°:',err));
    }
</script>
</body>
</html>
