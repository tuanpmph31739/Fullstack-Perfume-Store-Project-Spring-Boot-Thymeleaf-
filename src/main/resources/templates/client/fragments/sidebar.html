<!-- client/fragments/sidebar.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<body>
<!-- Tham số: brands, selectedBrands, selectedGender, minPrice, maxPrice, selfPath -->
<div class="col-md-3"
     th:fragment="productFilters(brands, selectedBrands, selectedGender, minPrice, maxPrice, maxPriceBound, selfPath)">

<div class="filter-box">
        <h5>Lọc sản phẩm</h5>

        <form th:action="${selfPath}" method="get">
            <!-- giữ lại các query đã chọn ngoài form -->
            <input type="hidden" name="page" value="1"/>

            <!-- Brand -->
            <div class="filter-category">
                <h6>Thương hiệu</h6>
                <ul class="list-unstyled mb-2">
                    <li th:each="brand : ${brands}">
                        <label class="d-flex align-items-center gap-2">
                            <input type="checkbox"
                                   name="brand"
                                   th:value="${brand.id}"
                                   th:checked="${selectedBrands != null and #lists.contains(selectedBrands, brand.id.intValue())}">

                            <span th:text="${brand.tenThuongHieu}">Brand</span>
                        </label>
                    </li>
                </ul>
            </div>

            <!-- Gender -->
            <div class="filter-gender">
                <h6>Giới tính</h6>
                <label class="d-block">
                    <input type="radio" name="gender" value=""
                           th:checked="${selectedGender == null or selectedGender == ''}"> Tất cả
                </label>
                <label class="d-block">
                    <input type="radio" name="gender" value="nam"
                           th:checked="${selectedGender == 'nam'}"> Nam
                </label>
                <label class="d-block">
                    <input type="radio" name="gender" value="nu"
                           th:checked="${selectedGender == 'nu'}"> Nữ
                </label>
                <label class="d-block">
                    <input type="radio" name="gender" value="unisex"
                           th:checked="${selectedGender == 'unisex'}"> Unisex
                </label>
            </div>

            <div class="filter-price mt-3"
                 th:with="
        maxBound=${maxPriceBound}?:50000000,
        minVal=${minPrice}?:0,
        maxVal=${maxPrice}?:${maxBound}">
                <h6>Khoảng giá</h6>

                <!-- 2 thanh range chồng lên nhau -->
                <div class="range-slider mb-1">
                    <input type="range"
                           id="priceMinRange"
                           min="0"
                           th:attr="max=${maxBound}"
                           step="500000"
                           th:value="${minVal}">
                    <input type="range"
                           id="priceMaxRange"
                           min="0"
                           th:attr="max=${maxBound}"
                           step="500000"
                           th:value="${maxVal}">
                </div>

                <!-- Hiển thị số -->
                <div class="small">
                    Từ
                    <strong id="priceMinText"
                            th:text="${#numbers.formatDecimal(minVal, 0, 'POINT', 0, 'NONE')}">0</strong> ₫
                    đến
                    <strong id="priceMaxText"
                            th:text="${#numbers.formatDecimal(maxVal, 0, 'POINT', 0, 'NONE')}">0</strong> ₫
                </div>

                <!-- Giá trị thực gửi lên server -->
                <input type="hidden" name="min" id="priceMin" th:value="${minVal}">
                <input type="hidden" name="max" id="priceMax" th:value="${maxVal}">
            </div>




            <div class="mt-3 d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm">Áp dụng</button>
                <a class="btn btn-outline-secondary btn-sm" th:href="${selfPath}">Xóa lọc</a>
            </div>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const minRange = document.getElementById('priceMinRange');
            const maxRange = document.getElementById('priceMaxRange');
            const minHidden = document.getElementById('priceMin');
            const maxHidden = document.getElementById('priceMax');
            const minText = document.getElementById('priceMinText');
            const maxText = document.getElementById('priceMaxText');
            const STEP = 500000;      // bước nhảy
            const MIN_GAP = STEP;     // khoảng cách tối thiểu giữa 2 đầu

            if (!minRange || !maxRange) return;

            function syncFromRange(e) {
                let minVal = parseInt(minRange.value || '0', 10);
                let maxVal = parseInt(maxRange.value || '0', 10);

                const isMin = e && e.target === minRange;

                // Không cho 2 đầu chồng nhau
                if (minVal > maxVal - MIN_GAP) {
                    if (isMin) {
                        minVal = maxVal - MIN_GAP;
                        minRange.value = minVal;
                    } else {
                        maxVal = minVal + MIN_GAP;
                        maxRange.value = maxVal;
                    }
                }

                if (minHidden) minHidden.value = minVal;
                if (maxHidden) maxHidden.value = maxVal;

                if (minText) minText.textContent = minVal.toLocaleString('vi-VN');
                if (maxText) maxText.textContent = maxVal.toLocaleString('vi-VN');
            }

            minRange.addEventListener('input', syncFromRange);
            maxRange.addEventListener('input', syncFromRange);

            // đồng bộ lại lần đầu theo giá trị từ server
            syncFromRange();
        });
    </script>

</div>
</body>
</html>
