<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{client/fragments/head :: head}"></head>
<body>
<div th:replace="~{client/fragments/header :: header}"></div>

<style>
    /* --- BỘ LỌC (FILTER) --- */
    .filter-section {
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        padding: 25px;
        border: 1px solid #f0f0f0;
    }
    .form-control, .btn-filter {
        height: 45px; /* Tăng chiều cao ô input cho đẹp */
        border-radius: 8px;
    }
    .btn-filter {
        background-color: var(--color-primary); /* Hoặc màu đen/xanh tùy theme */
        color: #fff;
        border: none;
        font-weight: 600;
        transition: all 0.3s;
    }
    .btn-filter:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* --- THẺ ĐƠN HÀNG (ORDER CARD) --- */
    .order-card {
        background: #fff;
        border: 1px solid #eef0f2;
        border-radius: 12px;
        transition: all 0.3s ease;
        margin-bottom: 20px; /* Khoảng cách giữa các đơn hàng */
        position: relative;
        overflow: hidden;
    }
    .order-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.06);
        border-color: var(--color-primary);
    }

    .order-header {
        background-color: #fcfcfc;
        border-bottom: 1px solid #f0f0f0;
        padding: 15px 20px;
    }
    .order-body {
        padding: 20px;
    }
    .product-preview-img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .status-badge {
        font-size: 0.8rem;
        padding: 6px 14px;
        border-radius: 30px;
        font-weight: 600;
        letter-spacing: 0.3px;
    }
    .price-tag {
        font-size: 1.1rem;
        color: var(--color-primary);
        font-weight: 700;
    }
</style>

<div class="container pd-wrap my-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="fw-bold text-dark m-0">Lịch sử đơn hàng</h3>
            <p class="text-muted small m-0">Quản lý và theo dõi các đơn hàng của bạn</p>
        </div>
        <a th:href="@{/}" class="btn btn-light border fw-bold rounded-pill px-4 hover-effect">
            <i class="bi bi-arrow-left me-1"></i> Mua sắm
        </a>
    </div>

    <div class="filter-section mb-5">
        <form th:action="@{/account/orders}" method="GET" class="row g-3 align-items-end">
            <div class="col-lg-5 col-md-12">
                <label class="form-label small fw-bold text-muted text-uppercase">Tìm kiếm</label>
                <div class="input-group">
                    <span class="input-group-text bg-white border-end-0 text-muted"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control border-start-0 ps-0" name="keyword" th:value="${keyword}"
                           placeholder="Nhập mã đơn, tên sản phẩm...">
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label small fw-bold text-muted text-uppercase">Từ ngày</label>
                <input type="date" class="form-control" name="fromDate" th:value="${fromDate}">
            </div>
            <div class="col-lg-3 col-md-6">
                <label class="form-label small fw-bold text-muted text-uppercase">Đến ngày</label>
                <input type="date" class="form-control" name="toDate" th:value="${toDate}">
            </div>
            <div class="col-lg-1 col-md-12">
                <button type="submit" class="btn btn-filter w-100 btn-primary">
                    <i class="bi bi-funnel-fill"></i>
                </button>
            </div>
        </form>
    </div>

    <div th:if="${orders.empty}" class="text-center py-5 bg-white rounded-4 shadow-sm">
        <div class="mb-3 text-muted opacity-25">
            <i class="bi bi-basket3 display-1"></i>
        </div>
        <h5 class="fw-bold text-dark">Chưa có đơn hàng nào</h5>
        <p class="text-muted">Hãy khám phá các sản phẩm tuyệt vời của chúng tôi.</p>
        <a th:href="@{/}" class="btn btn-dark rounded-pill px-4 mt-2">Khám phá ngay</a>
    </div>

    <div th:each="order : ${orders}" class="order-card">
        <div class="order-header d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-light p-2 rounded fw-bold text-dark border">
                    <i class="bi bi-upc-scan me-1"></i> <span th:text="${order.ma}">#HD123</span>
                </div>
                <span class="text-muted small border-start ps-3">
                    <i class="bi bi-calendar3 me-1"></i> <span th:text="${#temporals.format(order.ngayTao, 'dd/MM/yyyy HH:mm')}"></span>
                </span>
            </div>

            <div>
                <span th:if="${order.trangThai == 'CHO_XAC_NHAN'}" class="badge bg-warning-subtle text-warning-emphasis border border-warning-subtle status-badge">
                    <i class="bi bi-hourglass-split me-1"></i> Chờ xác nhận
                </span>
                <span th:if="${order.trangThai == 'DANG_CHO_THANH_TOAN'}" class="badge bg-info-subtle text-info-emphasis border border-info-subtle status-badge">
                    <i class="bi bi-credit-card me-1"></i> Chờ thanh toán
                </span>
                <span th:if="${order.trangThai == 'HOAN_THANH' or order.trangThai == 'HOÀN THÀNH'}" class="badge bg-success-subtle text-success-emphasis border border-success-subtle status-badge">
                    <i class="bi bi-check-circle-fill me-1"></i> Hoàn thành
                </span>
                <span th:if="${order.trangThai == 'DA_HUY'}" class="badge bg-danger-subtle text-danger-emphasis border border-danger-subtle status-badge">
                    <i class="bi bi-x-circle-fill me-1"></i> Đã hủy
                </span>
                <span th:if="${order.trangThai == 'DA_GIAO'}" class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle status-badge">
                    <i class="bi bi-box-seam-fill me-1"></i> Hoàn thành
                </span>
            </div>
        </div>

        <div class="order-body">
            <div class="row align-items-center g-4">

                <div class="col-md-7">
                    <div class="d-flex align-items-center" th:if="${not #lists.isEmpty(order.hoaDonChiTiets)}">
                        <div th:with="firstItem=${order.hoaDonChiTiets[0]}">
                            <div class="position-relative me-3">
                                <img th:src="@{'/images/uploads/' + ${firstItem.sanPhamChiTiet.hinhAnh}}"
                                     class="product-preview-img"
                                     onerror="this.src='/images/logo-fperfume.png'">

                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-dark border border-white"
                                      th:if="${order.hoaDonChiTiets.size() > 1}"
                                      th:text="'+' + (${order.hoaDonChiTiets.size() - 1})">
                                </span>
                            </div>
                        </div>

                        <div>
                            <h6 class="fw-bold text-dark mb-1"
                                th:text="${order.hoaDonChiTiets[0].sanPhamChiTiet.sanPham.tenNuocHoa}">
                                Tên sản phẩm
                            </h6>
                            <p class="text-muted small mb-0">
                                <span th:text="${order.hoaDonChiTiets[0].sanPhamChiTiet.dungTich.soMl + 'ml'}"></span>
                                &bull; x<span th:text="${order.hoaDonChiTiets[0].soLuong}"></span>
                                <span th:if="${order.hoaDonChiTiets.size() > 1}" class="fst-italic text-secondary ms-1">
                                    (và các sản phẩm khác...)
                                </span>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="col-md-5 text-md-end">
                    <div class="mb-2">
                        <span class="text-muted small text-uppercase me-2">Tổng thanh toán:</span>
                        <span class="price-tag" th:text="${#numbers.formatDecimal(order.tongThanhToan, 0, 'POINT', 0, 'NONE')} + ' ₫'"></span>
                    </div>

                    <a th:href="@{/account/orders/{id}(id=${order.id})}" class="btn btn-outline-dark rounded-pill px-4 fw-bold btn-sm stretched-link">
                        Xem chi tiết
                    </a>
                </div>
            </div>
        </div>
    </div>

</div>

<div th:replace="~{client/fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>