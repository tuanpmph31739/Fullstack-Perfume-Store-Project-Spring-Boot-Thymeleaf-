<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head th:replace="~{client/fragments/head :: head}"></head>
<body>

<!-- HEADER CHUNG -->
<div th:replace="~{client/fragments/header :: header}"></div>

<main class="auth-page">
    <div class="container">
        <div class="row justify-content-center">
            <!-- ✅ TĂNG ĐỘ RỘNG CỘT Ở ĐÂY -->
            <div class="col-md-10 col-lg-8 col-xl-7">

                <div class="auth-card">
                    <h2 class="auth-title mb-1">Địa chỉ nhận hàng</h2>
                    <p class="auth-subtitle mb-3">
                        Cập nhật địa chỉ để lần sau đặt hàng nhanh hơn tại <strong>F Perfume</strong>.
                    </p>

                    <!-- Địa chỉ hiện tại -->
                    <div class="mb-3 small text-muted" th:if="${user.diaChi != null}">
                        <span class="fw-semibold">Địa chỉ hiện tại:</span>
                        <span th:text="${user.diaChi}">Chưa có</span>
                    </div>

                    <form id="addressForm"
                          th:action="@{/account/address}"
                          method="post"
                          autocomplete="off">

                        <!-- Họ tên -->
                        <div class="mb-3">
                            <label class="form-label auth-label-readonly">Họ tên</label>
                            <input type="text"
                                   id="hoTen"
                                   name="hoTen"
                                   class="form-control auth-input"
                                   placeholder="Nhập họ tên"
                                   th:value="${user.hoTen}" readonly>
                        </div>

                        <!-- Số ĐT -->
                        <div class="mb-3">
                            <label class="form-label auth-label">Số điện thoại</label>
                            <input type="text"
                                   id="sdt"
                                   name="sdt"
                                   class="form-control auth-input-readonly"
                                   placeholder="Nhập số điện thoại"
                                   th:value="${user.sdt}" readonly>
                        </div>

                        <!-- hidden: full address (bind với user.diaChi) -->
                        <input type="hidden"
                               id="fullAddress"
                               name="diaChi"
                               th:value="${user.diaChi}"/>

                        <!-- Địa chỉ chi tiết -->
                        <div class="mb-3">
                            <label class="form-label auth-label">Số nhà, tên đường</label>
                            <input type="text"
                                   id="street"
                                   class="form-control auth-input"
                                   placeholder="Ví dụ: Số 10, Ngõ 5...">
                        </div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label auth-label">Tỉnh / TP</label>
                                <select id="province"
                                        class="form-select auth-input">
                                    <option value="">Chọn Tỉnh/TP</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label auth-label">Quận / Huyện</label>
                                <select id="district"
                                        class="form-select auth-input"
                                        disabled>
                                    <option value="">Chọn Quận/Huyện</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label auth-label">Phường / Xã</label>
                                <select id="ward"
                                        class="form-select auth-input"
                                        disabled>
                                    <option value="">Chọn Phường/Xã</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit"
                                class="btn auth-btn mt-4 w-100">
                            Lưu địa chỉ
                        </button>
                    </form>

                    <p class="mt-4 mb-0 auth-footer-text">
                        <a th:href="@{/}" class="auth-link">← Về trang chủ</a>
                    </p>
                </div>

            </div>
        </div>
    </div>
</main>

<!-- FOOTER CHUNG -->
<div th:replace="~{client/fragments/footer :: footer}"></div>

<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .auth-page {
        background: #f5f1ec;
        min-height: calc(100vh - 200px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 0;
    }
    .auth-page > .container {
        width: 100%;
    }

    .auth-card {
        background:white;
        padding:40px 32px;
        border-radius:16px;
        border:1px solid #eee3d6;
        box-shadow:0 18px 40px rgba(0,0,0,0.06);
        /* ✅ CHO NÓ RỘNG HƠN MÀ VẪN GỌN */
        max-width: 900px;
        margin: 0 auto;
    }

    .auth-title {
        text-align:left;
        color:#3b3027;
        margin-bottom:4px;
        font-size:1.5rem;
        font-weight:600;
    }
    .auth-subtitle {
        font-size:0.9rem;
        color:#7b6a5c;
    }
    .auth-label {
        font-weight:500;
        color:#5c5147;
        font-size:0.85rem;
    }
    .auth-input {
        width:100%;
        padding:10px 11px;
        margin-top:4px;
        border:1px solid #d3c3b2;
        border-radius:10px;
        font-size:0.95rem;
    }
    .auth-input:focus {
        border-color:#9E8C7C;
        box-shadow:0 0 0 0.15rem rgba(158,140,124,0.25);
    }
    .auth-btn {
        background:#9E8C7C;
        color:white;
        border:none;
        padding:11px 16px;
        border-radius:999px;
        font-size:0.95rem;
        font-weight:600;
        cursor:pointer;
        transition:0.3s;
        letter-spacing:0.03em;
        text-transform:uppercase;
    }
    .auth-btn:hover {
        background:#857566;
        color:#fff;
    }
    .auth-footer-text {
        font-size:0.9rem;
        color:#6b6055;
        text-align:center;
    }
    .auth-link {
        color:#9E8C7C;
        font-weight:600;
        text-decoration:none;
    }
    .auth-link:hover {
        color:#7f6f63;
        text-decoration:underline;
    }
    .auth-input-readonly[readonly] {
        background-color: #f5f5f5;
        cursor: not-allowed;
    }

</style>

<!-- Hiển thị toast sau khi lưu thành công -->
<script th:inline="javascript">
    const successMessage = /*[[${successMessage}]]*/ null;
    if (successMessage) {
        Swal.fire({
            icon: 'success',
            title: 'Thành công',
            text: successMessage,
            timer: 1800,
            showConfirmButton: false
        });
    }
</script>

<!-- JS chọn Tỉnh / Huyện / Xã (dùng chung logic với checkout) -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const provinceSelect   = document.getElementById("province");
        const districtSelect   = document.getElementById("district");
        const wardSelect       = document.getElementById("ward");
        const streetInput      = document.getElementById("street");
        const fullAddressInput = document.getElementById("fullAddress");
        const addressForm      = document.getElementById("addressForm");

        // Địa chỉ hiện tại từ DB (user.diaChi)
        const existingAddressRaw = fullAddressInput && fullAddressInput.value
            ? fullAddressInput.value.trim()
            : "";

        function splitAddress(addr) {
            const parts = addr.split(',')
                .map(p => p.trim())
                .filter(p => p.length > 0);

            let province = "", district = "", ward = "", street = "";

            if (parts.length >= 4) {
                province = parts[parts.length - 1];
                district = parts[parts.length - 2];
                ward     = parts[parts.length - 3];
                street   = parts.slice(0, parts.length - 3).join(", ");
            } else if (parts.length === 3) {
                province = parts[2];
                district = parts[1];
                street   = parts[0];
            } else if (parts.length === 2) {
                province = parts[1];
                street   = parts[0];
            } else if (parts.length === 1) {
                street   = parts[0];
            }
            return { province, district, ward, street };
        }

        function findOptionByName(select, targetName) {
            if (!targetName) return null;
            const normTarget = targetName.toLowerCase();
            let found = null;
            Array.from(select.options).forEach(opt => {
                const name = (opt.getAttribute("data-name") || opt.textContent || "").toLowerCase();
                if (!name) return;
                if (name === normTarget || name.includes(normTarget) || normTarget.includes(name)) {
                    found = opt;
                }
            });
            return found;
        }

        function updateFullAddress() {
            const p = provinceSelect.options[provinceSelect.selectedIndex]?.getAttribute("data-name") || "";
            const d = districtSelect.options[districtSelect.selectedIndex]?.getAttribute("data-name") || "";
            const w = wardSelect.options[wardSelect.selectedIndex]?.getAttribute("data-name") || "";
            const s = streetInput.value.trim();

            const arr = [];
            if (s) arr.push(s);
            if (w) arr.push(w);
            if (d) arr.push(d);
            if (p) arr.push(p);

            fullAddressInput.value = arr.join(", ");
        }

        function autoFillAddressFromExisting() {
            if (!existingAddressRaw) return;

            const parts = splitAddress(existingAddressRaw);
            if (!parts.province) return;

            const provOpt = findOptionByName(provinceSelect, parts.province);
            if (!provOpt) return;

            provinceSelect.value = provOpt.value;

            if (parts.street) {
                streetInput.value = parts.street;
            }

            districtSelect.disabled = false;
            fetch(`https://esgoo.net/api-tinhthanh/2/${provOpt.value}.htm`)
                .then(r => r.json())
                .then(data => {
                    districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                    if (data.error === 0) {
                        data.data.forEach(item => {
                            let opt = new Option(item.full_name, item.id);
                            opt.setAttribute("data-name", item.full_name);
                            districtSelect.add(opt);
                        });
                    }

                    if (!parts.district) {
                        updateFullAddress();
                        return;
                    }

                    const distOpt = findOptionByName(districtSelect, parts.district);
                    if (!distOpt) {
                        updateFullAddress();
                        return;
                    }
                    districtSelect.value = distOpt.value;

                    wardSelect.disabled = false;
                    return fetch(`https://esgoo.net/api-tinhthanh/3/${distOpt.value}.htm`)
                        .then(r => r.json())
                        .then(data2 => {
                            wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
                            if (data2.error === 0) {
                                data2.data.forEach(item => {
                                    let opt = new Option(item.full_name, item.id);
                                    opt.setAttribute("data-name", item.full_name);
                                    wardSelect.add(opt);
                                });
                            }

                            if (parts.ward) {
                                const wardOpt = findOptionByName(wardSelect, parts.ward);
                                if (wardOpt) {
                                    wardSelect.value = wardOpt.value;
                                }
                            }
                            updateFullAddress();
                        });
                })
                .catch(err => console.error("Lỗi auto-fill địa chỉ:", err));
        }

        fetch('https://esgoo.net/api-tinhthanh/1/0.htm')
            .then(r => r.json())
            .then(data => {
                if (data.error === 0) {
                    data.data.forEach(item => {
                        let opt = new Option(item.full_name, item.id);
                        opt.setAttribute("data-name", item.full_name);
                        provinceSelect.add(opt);
                    });
                }
                autoFillAddressFromExisting();
            });

        provinceSelect.addEventListener("change", function () {
            districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
            wardSelect.innerHTML     = '<option value="">Chọn Phường/Xã</option>';
            wardSelect.disabled      = true;

            if (this.value) {
                districtSelect.disabled = false;
                fetch(`https://esgoo.net/api-tinhthanh/2/${this.value}.htm`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.error === 0) {
                            data.data.forEach(item => {
                                let opt = new Option(item.full_name, item.id);
                                opt.setAttribute("data-name", item.full_name);
                                districtSelect.add(opt);
                            });
                        }
                    });
            }
            updateFullAddress();
        });

        districtSelect.addEventListener("change", function () {
            wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
            if (this.value) {
                wardSelect.disabled = false;
                fetch(`https://esgoo.net/api-tinhthanh/3/${this.value}.htm`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.error === 0) {
                            data.data.forEach(item => {
                                let opt = new Option(item.full_name, item.id);
                                opt.setAttribute("data-name", item.full_name);
                                wardSelect.add(opt);
                            });
                        }
                    });
            }
            updateFullAddress();
        });

        wardSelect.addEventListener("change", updateFullAddress);
        streetInput.addEventListener("input", updateFullAddress);

        addressForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const street = streetInput.value.trim();

            if (!provinceSelect.value || !districtSelect.value || !wardSelect.value || !street) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi',
                    text: 'Vui lòng nhập đầy đủ địa chỉ'
                });
                return;
            }

            updateFullAddress();

            Swal.fire({
                title: 'Xác nhận lưu địa chỉ?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Lưu',
                cancelButtonText: 'Hủy'
            }).then(result => {
                if (result.isConfirmed) {
                    addressForm.submit();
                }
            });
        });
    });
</script>

</body>
</html>
