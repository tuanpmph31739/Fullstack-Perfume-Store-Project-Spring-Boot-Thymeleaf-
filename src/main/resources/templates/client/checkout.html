<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{client/fragments/head :: head}"></head>
<body>
<div th:replace="~{client/fragments/header :: header}"></div>

<style>
    .checkout-section {
        background-color: #fff;
        border-radius: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        padding: 30px;
    }
    .form-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #555;
    }
    .form-control, .form-select {
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        font-size: 0.95rem;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.1);
    }
    /* Payment Radio Custom */
    .payment-option {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 10px;
        transition: all 0.3s;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .payment-option:hover {
        background-color: #f9f9f9;
    }
    .payment-option.selected {
        border-color: var(--color-primary);
        background-color: rgba(var(--color-primary-rgb), 0.03);
    }
    .payment-option .form-check-input {
        margin-right: 15px;
        cursor: pointer;
    }
    .summary-card {
        background-color: #f8f9fa;
        border: none;
        border-radius: 16px;
    }
    .input-group-text {
        background-color: #f1f1f1;
        border: 1px solid #e0e0e0;
        color: #555;
    }
</style>

<div class="container my-5">
    <div class="text-center mb-5">
        <h2 class="fw-bold text-dark">Thanh To√°n ƒê∆°n H√†ng</h2>
        <p class="text-muted">Vui l√≤ng ki·ªÉm tra k·ªπ th√¥ng tin tr∆∞·ªõc khi ƒë·∫∑t h√†ng</p>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger rounded-pill px-4 text-center shadow-sm mb-4">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> <span th:text="${errorMessage}"></span>
    </div>

    <form th:action="@{/order/submit}" method="POST" th:object="${checkoutForm}" id="checkoutForm">
        <div class="row g-4">

            <div class="col-lg-7">
                <div class="checkout-section h-100">
                    <h5 class="mb-4 fw-bold"><i class="bi bi-person-bounding-box me-2 text-primary"></i>Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h5>

                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">H·ªç v√† t√™n <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" th:field="*{tenNguoiNhan}" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
                            <div th:if="${#fields.hasErrors('tenNguoiNhan')}" th:errors="*{tenNguoiNhan}" class="text-danger small mt-1"></div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <select class="form-select flex-grow-0 w-auto bg-light" style="width: 100px;">
                                    <option value="+84" selected>üáªüá≥ +84</option>
                                    <option value="+1">üá∫üá∏ +1</option>
                                    <option value="+81">üáØüáµ +81</option>
                                </select>
                                <input type="tel" class="form-control" th:field="*{sdt}" placeholder="S·ªë ƒëi·ªán tho·∫°i..." id="phoneInput">
                            </div>
                            <div th:if="${#fields.hasErrors('sdt')}" th:errors="*{sdt}" class="text-danger small mt-1"></div>
                            <div id="phoneError" class="text-danger small mt-1 d-none">S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (Ph·∫£i c√≥ 10 s·ªë).</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Email (ƒê·ªÉ nh·∫≠n h√≥a ƒë∆°n)</label>
                            <input type="email" class="form-control" th:field="*{email}" placeholder="email@example.com">
                            <div th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="text-danger small mt-1"></div>
                        </div>

                        <div class="col-12 mt-4">
                            <h6 class="fw-bold mb-3 text-muted text-uppercase small ls-1">ƒê·ªãa ch·ªâ giao h√†ng</h6>

                            <input type="hidden" id="fullAddress" th:field="*{diaChi}">

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">T·ªânh / Th√†nh ph·ªë <span class="text-danger">*</span></label>
                                    <select class="form-select" id="province">
                                        <option value="">Ch·ªçn T·ªânh/TP</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Qu·∫≠n / Huy·ªán <span class="text-danger">*</span></label>
                                    <select class="form-select" id="district" disabled>
                                        <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Ph∆∞·ªùng / X√£ <span class="text-danger">*</span></label>
                                    <select class="form-select" id="ward" disabled>
                                        <option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">S·ªë nh√†, T√™n ƒë∆∞·ªùng <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="street" placeholder="VD: S·ªë 10, Ng√µ 5, ƒê∆∞·ªùng C·∫ßu Gi·∫•y">
                                </div>
                            </div>
                            <div th:if="${#fields.hasErrors('diaChi')}" th:errors="*{diaChi}" class="text-danger small mt-1"></div>
                        </div>
                    </div>

                    <div class="mt-5">
                        <h5 class="mb-3 fw-bold"><i class="bi bi-credit-card me-2 text-primary"></i>Ph∆∞∆°ng th·ª©c thanh to√°n</h5>

                        <label class="payment-option" for="thanhToan1">
                            <div class="form-check w-100">
                                <input class="form-check-input" type="radio" th:field="*{idThanhToan}" value="1" id="thanhToan1" checked>
                                <label class="form-check-label d-flex justify-content-between align-items-center w-100" for="thanhToan1">
                                    <span><i class="bi bi-cash-stack me-2 text-success"></i> Thanh to√°n khi nh·∫≠n h√†ng (COD)</span>
                                </label>
                            </div>
                        </label>

                        <label class="payment-option" for="thanhToan3">
                            <div class="form-check w-100">
                                <input class="form-check-input" type="radio" th:field="*{idThanhToan}" value="3" id="thanhToan3">
                                <label class="form-check-label d-flex justify-content-between align-items-center w-100" for="thanhToan3">
                                    <span>
                                        <img src="https://vnpay.vn/s1/statics.vnpay.vn/2023/9/06ncktiwd6dc1694418196384.png" alt="VNPay" style="height: 24px; margin-right: 8px;">
                                        Thanh to√°n qua VNPay
                                    </span>
                                </label>
                            </div>
                        </label>

                        <div th:if="${#fields.hasErrors('idThanhToan')}" th:errors="*{idThanhToan}" class="text-danger small mt-2"></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card summary-card shadow-sm sticky-top" style="top: 20px; z-index: 1;">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">ƒê∆°n h√†ng c·ªßa b·∫°n</h5>

                        <div class="overflow-auto mb-3" style="max-height: 300px;">
                            <ul class="list-group list-group-flush bg-transparent">
                                <li th:each="item : ${gioHang.gioHangChiTiets}" class="list-group-item bg-transparent d-flex justify-content-between px-0 py-3 border-bottom-dashed">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3 position-relative">
                                            <img th:src="@{/images/logo-fperfume.png}"
                                                 class="rounded border" style="width: 50px; height: 50px; object-fit: cover;">
                                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary"
                                                  th:text="${item.soLuong}" style="font-size: 0.65rem;">1</span>
                                        </div>
                                        <div>
                                            <h6 class="mb-0 small fw-semibold" th:text="${item.sanPhamChiTiet.sanPham.tenNuocHoa}">T√™n SP</h6>
                                            <small class="text-muted" th:text="${item.sanPhamChiTiet.dungTich.soMl + 'ml'}">50ml</small>
                                        </div>
                                    </div>
                                    <span class="small fw-bold" th:text="${#numbers.formatDecimal(item.sanPhamChiTiet.giaBan.multiply(item.soLuong), 0, 'POINT', 0, 'NONE')} + ' ‚Ç´'"></span>
                                </li>
                            </ul>
                        </div>

                        <div class="pt-2">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">T·∫°m t√≠nh:</span>
                                <span class="fw-semibold" th:text="${#numbers.formatDecimal(tongTienHang, 0, 'POINT', 0, 'NONE')} + ' ‚Ç´'"></span>
                            </div>

                            <div th:if="${tienGiamGia > 0}" class="d-flex justify-content-between mb-2 text-success">
                                <span><i class="bi bi-ticket-perforated-fill me-1"></i>Gi·∫£m gi√°:</span>
                                <span th:text="'- ' + ${#numbers.formatDecimal(tienGiamGia, 0, 'POINT', 0, 'NONE')} + ' ‚Ç´'"></span>
                            </div>

                            <div class="d-flex justify-content-between mb-3">
                                <span class="text-muted">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                                <span class="fw-semibold">30.000 ‚Ç´</span>
                            </div>

                            <hr style="border-style: dashed;">

                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <span class="fs-5 fw-bold">T·ªïng c·ªông:</span>
                                <span class="fs-4 fw-bold text-primary"
                                      th:text="${#numbers.formatDecimal(tongThanhToan + 30000, 0, 'POINT', 0, 'NONE')} + ' ‚Ç´'"></span>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold text-uppercase shadow hover-effect"
                                style="background-color: var(--color-primary); border: none; letter-spacing: 1px;">
                            ƒê·∫∑t h√†ng ngay
                        </button>

                        <div class="text-center mt-3">
                            <a th:href="@{/cart}" class="text-decoration-none small text-muted hover-link">
                                <i class="bi bi-arrow-left me-1"></i> Quay l·∫°i gi·ªè h√†ng
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<div th:replace="~{client/fragments/footer :: footer}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // 1. X·ª≠ l√Ω ch·ªçn hi·ªáu ·ª©ng Payment
        const radioInputs = document.querySelectorAll('.payment-option input[type="radio"]');
        function updatePaymentUI() {
            document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
            const checked = document.querySelector('.payment-option input[type="radio"]:checked');
            if(checked) checked.closest('.payment-option').classList.add('selected');
        }
        radioInputs.forEach(input => input.addEventListener('change', updatePaymentUI));
        updatePaymentUI(); // Init

        // 2. API ƒê·ªäA CH·ªà (VIETNAM)
        const provinceSelect = document.getElementById("province");
        const districtSelect = document.getElementById("district");
        const wardSelect = document.getElementById("ward");
        const streetInput = document.getElementById("street");
        const fullAddressInput = document.getElementById("fullAddress");

        // Fetch T·ªânh/Th√†nh ph·ªë
        fetch('https://esgoo.net/api-tinhthanh/1/0.htm')
            .then(response => response.json())
            .then(data => {
                if (data.error === 0) {
                    data.data.forEach(item => {
                        let option = new Option(item.full_name, item.id);
                        option.setAttribute("data-name", item.full_name);
                        provinceSelect.add(option);
                    });
                }
            });

        // Khi ch·ªçn T·ªânh -> Load Huy·ªán
        provinceSelect.addEventListener("change", function () {
            districtSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
            wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
            wardSelect.disabled = true;

            if (this.value) {
                districtSelect.disabled = false;
                fetch(`https://esgoo.net/api-tinhthanh/2/${this.value}.htm`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error === 0) {
                            data.data.forEach(item => {
                                let option = new Option(item.full_name, item.id);
                                option.setAttribute("data-name", item.full_name);
                                districtSelect.add(option);
                            });
                        }
                    });
            } else {
                districtSelect.disabled = true;
            }
            updateFullAddress();
        });

        // Khi ch·ªçn Huy·ªán -> Load X√£
        districtSelect.addEventListener("change", function () {
            wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';

            if (this.value) {
                wardSelect.disabled = false;
                fetch(`https://esgoo.net/api-tinhthanh/3/${this.value}.htm`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error === 0) {
                            data.data.forEach(item => {
                                let option = new Option(item.full_name, item.id);
                                option.setAttribute("data-name", item.full_name);
                                wardSelect.add(option);
                            });
                        }
                    });
            } else {
                wardSelect.disabled = true;
            }
            updateFullAddress();
        });

        wardSelect.addEventListener("change", updateFullAddress);
        streetInput.addEventListener("input", updateFullAddress);

        // H√†m g·ªôp ƒë·ªãa ch·ªâ
        function updateFullAddress() {
            const provinceText = provinceSelect.options[provinceSelect.selectedIndex]?.getAttribute("data-name") || "";
            const districtText = districtSelect.options[districtSelect.selectedIndex]?.getAttribute("data-name") || "";
            const wardText = wardSelect.options[wardSelect.selectedIndex]?.getAttribute("data-name") || "";
            const streetText = streetInput.value.trim();

            let addressParts = [];
            if (streetText) addressParts.push(streetText);
            if (wardText) addressParts.push(wardText);
            if (districtText) addressParts.push(districtText);
            if (provinceText) addressParts.push(provinceText);

            fullAddressInput.value = addressParts.join(", ");
        }

        // 3. VALIDATE FORM TR∆Ø·ªöC KHI SUBMIT
        const form = document.getElementById("checkoutForm");
        const phoneInput = document.getElementById("phoneInput");
        const phoneError = document.getElementById("phoneError");

        form.addEventListener("submit", function(e) {
            let isValid = true;

            // Validate Phone (C∆° b·∫£n: 10 s·ªë, b·∫Øt ƒë·∫ßu s·ªë 0)
            const phoneRegex = /(84|0[3|5|7|8|9])+([0-9]{8})\b/g;
            if (!phoneRegex.test(phoneInput.value)) {
                phoneInput.classList.add("is-invalid");
                phoneError.classList.remove("d-none");
                isValid = false;
            } else {
                phoneInput.classList.remove("is-invalid");
                phoneError.classList.add("d-none");
            }

            // Validate ƒê·ªãa ch·ªâ
            if (!provinceSelect.value || !districtSelect.value || !wardSelect.value || !streetInput.value) {
                alert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ƒë·ªãa ch·ªâ nh·∫≠n h√†ng!");
                isValid = false;
            }

            if (!isValid) e.preventDefault();
        });
    });
</script>

</body>
</html>